{% extends "admin_base.html" %}

{% block title %}Live Trending Hijacker - DIAMOND SYSTEM{% endblock %}

{% block head %}
{{ super() }}
<style>
.trending-hijacker-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ff6b6b 100%);
    border-radius: 20px;
    padding: 30px;
    margin: 20px 0;
    color: white;
    text-align: center;
    box-shadow: 0 15px 35px rgba(31, 38, 135, 0.37);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    position: relative;
    overflow: hidden;
}

.trending-hijacker-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.diamond-badge {
    background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
    color: white;
    padding: 8px 20px;
    border-radius: 25px;
    font-weight: bold;
    font-size: 1.1em;
    display: inline-block;
    margin: 10px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.trend-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 20px;
    margin: 15px 0;
    color: white;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    transition: all 0.3s ease;
}

.trend-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 45px rgba(31, 38, 135, 0.5);
}

.trend-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
}

.trend-status {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: bold;
    margin-left: 10px;
}

.status-detected { background: #feca57; color: #333; }
.status-analyzed { background: #48dbfb; color: #333; }
.status-hijacked { background: #00ff88; color: #333; }
.status-viral { background: #ff6b6b; color: white; }

.viral-score {
    display: inline-block;
    background: linear-gradient(45deg, #ff6b6b, #feca57);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
    margin: 5px;
}

.opportunity-score {
    display: inline-block;
    background: linear-gradient(45deg, #48dbfb, #ff9ff3);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
    margin: 5px;
}

.hijack-btn {
    background: linear-gradient(45deg, #ff6b6b, #764ba2);
    border: none;
    color: white;
    padding: 12px 25px;
    border-radius: 25px;
    font-weight: bold;
    transition: all 0.3s ease;
    margin: 5px;
    cursor: pointer;
}

.hijack-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    background: linear-gradient(45deg, #ff5252, #673ab7);
}

.monitoring-status {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    padding: 20px;
    border-radius: 15px;
    margin: 20px 0;
    color: white;
}

.status-indicator {
    display: inline-flex;
    align-items: center;
    padding: 10px 15px;
    border-radius: 25px;
    font-weight: bold;
    margin: 5px;
}

.status-active {
    background: linear-gradient(45deg, #00ff88, #00cec9);
    animation: pulse 2s infinite;
}

.status-inactive {
    background: linear-gradient(45deg, #636e72, #2d3436);
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.metric-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    backdrop-filter: blur(5px);
}

.metric-value {
    font-size: 2.5em;
    font-weight: bold;
    color: #00ff88;
    margin: 10px 0;
}

.metric-label {
    color: #ccc;
    font-size: 0.9em;
}

.platform-performance {
    margin: 20px 0;
}

.platform-card {
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    padding: 15px;
    border-radius: 10px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.platform-stats {
    display: flex;
    gap: 20px;
}

.platform-stat {
    text-align: center;
}

.platform-stat-value {
    font-weight: bold;
    font-size: 1.2em;
    color: #00ff88;
}

.platform-stat-label {
    font-size: 0.8em;
    color: #ccc;
}

.response-preview {
    background: rgba(0, 0, 0, 0.2);
    padding: 15px;
    border-radius: 10px;
    margin: 10px 0;
    border-left: 4px solid #00ff88;
}

.response-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
}

.success-rating {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}

.rating-ultra { background: #ff6b6b; color: white; }
.rating-high { background: #feca57; color: #333; }
.rating-medium { background: #48dbfb; color: #333; }
.rating-low { background: #636e72; color: white; }

.hijack-progress {
    margin: 20px 0;
    padding: 20px;
    background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
    border-radius: 15px;
    display: none;
}

.progress-enhanced {
    height: 30px;
    background: rgba(255,255,255,0.1);
    border-radius: 15px;
    overflow: hidden;
    margin: 15px 0;
}

.progress-bar-enhanced {
    background: linear-gradient(45deg, #00ff88, #00cec9);
    height: 100%;
    border-radius: 15px;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.real-time-feed {
    max-height: 400px;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 10px;
    padding: 15px;
}

.feed-item {
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin: 5px 0;
}

.feed-timestamp {
    color: #74b9ff;
    font-size: 0.8em;
}

.feed-message {
    margin-top: 5px;
}

.control-panel {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    padding: 25px;
    border-radius: 20px;
    margin: 20px 0;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hero Section -->
    <div class="trending-hijacker-hero">
        <h1><i class="fas fa-rocket"></i> Live Trending Hijacker</h1>
        <div class="diamond-badge">ðŸ’Ž DIAMOND SYSTEM</div>
        <h3>Real-time viral trend capture with 2-hour response capability</h3>
        <div class="mt-3">
            <div class="viral-score">+$6,000/month Revenue Potential</div>
            <div class="opportunity-score">First-Mover Advantage Technology</div>
        </div>
    </div>

    <!-- Monitoring Status Dashboard -->
    <div class="monitoring-status">
        <div class="row">
            <div class="col-12">
                <h4><i class="fas fa-satellite-dish"></i> Live Monitoring Status</h4>
            </div>
        </div>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="monitoringStatus">INACTIVE</div>
                <div class="metric-label">System Status</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="trendsDetected">0</div>
                <div class="metric-label">Trends Detected (24h)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="hijacksCompleted">0</div>
                <div class="metric-label">Hijacks Completed</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="successRate">0%</div>
                <div class="metric-label">Success Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="dailyRevenue">$0</div>
                <div class="metric-label">Daily Revenue Potential</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="monthlyRevenue">$0</div>
                <div class="metric-label">Monthly Revenue Potential</div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <h4><i class="fas fa-control-alt"></i> Hijacker Control Panel</h4>
        <div class="row mt-3">
            <div class="col-md-6">
                <button class="btn hijack-btn" onclick="startTrendingMonitoring()">
                    <i class="fas fa-play"></i> Start Live Monitoring
                </button>
                <button class="btn hijack-btn" onclick="stopTrendingMonitoring()">
                    <i class="fas fa-stop"></i> Stop Monitoring
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn hijack-btn" onclick="refreshDashboard()">
                    <i class="fas fa-sync"></i> Refresh Dashboard
                </button>
                <button class="btn hijack-btn" onclick="exportHijackData()">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>
        </div>
    </div>

    <!-- Hijacking Progress -->
    <div class="hijack-progress" id="hijackProgress">
        <h5>ðŸŽ¯ Trend Hijacking in Progress...</h5>
        <div class="progress-enhanced">
            <div class="progress-bar-enhanced" id="hijackProgressBar" style="width: 0%;">0%</div>
        </div>
        <div id="hijackProgressStatus" class="mt-2"></div>
    </div>

    <!-- Live Trending Opportunities -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-fire text-danger"></i> Live Trending Opportunities</h5>
                    <small>Real-time viral trends with hijack potential</small>
                </div>
                <div class="card-body" style="background: #1a1a2e;" id="trendingOpportunities">
                    <p class="text-muted">Click "Start Live Monitoring" to detect viral trends</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Platform Performance -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-chart-pie"></i> Platform Performance</h5>
                </div>
                <div class="card-body" style="background: #1a1a2e;" id="platformPerformance">
                    <canvas id="platformChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-bolt"></i> Hijack Success Rate</h5>
                </div>
                <div class="card-body" style="background: #1a1a2e;" id="hijackSuccessRate">
                    <canvas id="successChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Viral Responses -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-music text-success"></i> Recent Viral Responses</h5>
                </div>
                <div class="card-body" style="background: #1a1a2e;" id="recentResponses">
                    <p class="text-muted">No viral responses generated yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Activity Feed -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-stream text-info"></i> Real-time Activity Feed</h5>
                </div>
                <div class="card-body" style="background: #1a1a2e;">
                    <div class="real-time-feed" id="activityFeed">
                        <div class="feed-item">
                            <div class="feed-timestamp">System Ready</div>
                            <div class="feed-message">Trending hijacker system initialized and ready for activation</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trend Hijack Modal -->
<div class="modal fade" id="hijackModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #1a1a2e; color: white;">
            <div class="modal-header">
                <h5 class="modal-title" id="hijackModalTitle">Trend Hijacking Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="hijackModalBody">
                <!-- Trend hijacking details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn hijack-btn" onclick="executeHijack()">ðŸš€ Execute Hijack</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let hijackerData = {};
let currentTrend = null;
let monitoringActive = false;
let activityFeedInterval = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    refreshDashboard();
});

// Start trending monitoring
async function startTrendingMonitoring() {
    try {
        showLoader('Starting live trending monitoring...');
        
        const response = await fetch('/api/trending/start-monitoring', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.success) {
            monitoringActive = true;
            document.getElementById('monitoringStatus').textContent = 'ACTIVE';
            document.getElementById('monitoringStatus').className = 'metric-value status-active';
            
            showSuccess(`Live monitoring started! Monitoring ${result.data.platforms_monitored} platforms with ${result.data.monitoring_threads} active threads.`);
            
            // Start real-time updates
            startRealTimeUpdates();
            
            // Refresh dashboard data
            refreshDashboard();
        } else {
            showError('Failed to start monitoring: ' + result.error);
        }
    } catch (error) {
        showError('Error starting monitoring: ' + error.message);
    } finally {
        hideLoader();
    }
}

// Stop trending monitoring
async function stopTrendingMonitoring() {
    try {
        const response = await fetch('/api/trending/stop-monitoring', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.success) {
            monitoringActive = false;
            document.getElementById('monitoringStatus').textContent = 'INACTIVE';
            document.getElementById('monitoringStatus').className = 'metric-value';
            
            stopRealTimeUpdates();
            showSuccess('Trending monitoring stopped');
        } else {
            showError('Failed to stop monitoring: ' + result.error);
        }
    } catch (error) {
        showError('Error stopping monitoring: ' + error.message);
    }
}

// Start real-time updates
function startRealTimeUpdates() {
    if (activityFeedInterval) {
        clearInterval(activityFeedInterval);
    }
    
    activityFeedInterval = setInterval(() => {
        if (monitoringActive) {
            refreshDashboard();
            addActivityFeedItem('trend_scan', 'Scanning platforms for viral trends...');
        }
    }, 30000); // Update every 30 seconds
}

// Stop real-time updates
function stopRealTimeUpdates() {
    if (activityFeedInterval) {
        clearInterval(activityFeedInterval);
        activityFeedInterval = null;
    }
}

// Refresh dashboard
async function refreshDashboard() {
    try {
        const response = await fetch('/api/trending/dashboard');
        const result = await response.json();
        
        if (result.success) {
            hijackerData = result.dashboard;
            updateDashboardMetrics(result.dashboard);
            displayTrendingOpportunities(result.dashboard.recent_trends);
            displayPlatformPerformance(result.dashboard.platform_performance);
            displayRecentResponses(result.dashboard.recent_responses);
        } else {
            showError('Failed to load dashboard: ' + result.error);
        }
    } catch (error) {
        showError('Error loading dashboard: ' + error.message);
    }
}

// Update dashboard metrics
function updateDashboardMetrics(dashboard) {
    document.getElementById('trendsDetected').textContent = dashboard.recent_trends.length;
    document.getElementById('hijacksCompleted').textContent = dashboard.hijacking_stats.hijacked_trends || 0;
    document.getElementById('successRate').textContent = dashboard.revenue_projections.hijack_success_rate.toFixed(1) + '%';
    document.getElementById('dailyRevenue').textContent = '$' + (dashboard.revenue_projections.daily_potential || 0).toLocaleString();
    document.getElementById('monthlyRevenue').textContent = '$' + (dashboard.revenue_projections.monthly_potential || 0).toLocaleString();
}

// Display trending opportunities
function displayTrendingOpportunities(trends) {
    const container = document.getElementById('trendingOpportunities');
    
    if (!trends || trends.length === 0) {
        container.innerHTML = '<p class="text-muted">No trending opportunities detected. Start monitoring to find viral trends.</p>';
        return;
    }
    
    let html = '';
    trends.slice(0, 10).forEach((trend, index) => {
        const statusClass = getStatusClass(trend.hijack_status);
        const priorityClass = trend.opportunity_score > 0.8 ? 'ultra-priority' : 
                             trend.opportunity_score > 0.6 ? 'high-priority' : 'medium-priority';
        
        html += `
            <div class="trend-card ${priorityClass}" onclick="showTrendDetails('${trend.track_id}')">
                <div class="trend-header">
                    <div>
                        <h6><i class="fas fa-fire"></i> ${trend.title}</h6>
                        <small>Platform: ${trend.platform} | Genre: ${trend.genre}</small>
                    </div>
                    <div class="trend-status ${statusClass}">${formatStatus(trend.hijack_status)}</div>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="trend-metrics">
                            <span class="viral-score">Viral: ${(trend.viral_score * 100).toFixed(0)}%</span>
                            <span class="opportunity-score">Opportunity: ${(trend.opportunity_score * 100).toFixed(0)}%</span>
                        </div>
                        <div class="mt-2">
                            <small>
                                Views: ${trend.view_count.toLocaleString()} | 
                                Growth: ${trend.growth_rate.toFixed(1)}x | 
                                Detected: ${formatTime(trend.detected_at)}
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        ${trend.hijack_status === 'detected' || trend.hijack_status === 'analyzed' ? 
                          `<button class="btn hijack-btn btn-sm" onclick="event.stopPropagation(); initiateHijack('${trend.track_id}')">
                             <i class="fas fa-rocket"></i> Hijack Now
                           </button>` : 
                          `<span class="success-rating rating-${getSuccessRating(trend.hijack_status)}">${formatStatus(trend.hijack_status)}</span>`
                        }
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Display platform performance
function displayPlatformPerformance(platforms) {
    if (!platforms || platforms.length === 0) return;
    
    const container = document.getElementById('platformPerformance');
    
    // Create chart data
    const platformNames = platforms.map(p => p.platform.replace('_', ' ').toUpperCase());
    const trendsDetected = platforms.map(p => p.trends_detected);
    const successfulHijacks = platforms.map(p => p.successful_hijacks);
    
    // Destroy existing chart if it exists
    if (window.platformChart) {
        window.platformChart.destroy();
    }
    
    const ctx = document.getElementById('platformChart').getContext('2d');
    window.platformChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: platformNames,
            datasets: [{
                data: trendsDetected,
                backgroundColor: [
                    '#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                }
            }
        }
    });
}

// Display recent responses
function displayRecentResponses(responses) {
    const container = document.getElementById('recentResponses');
    
    if (!responses || responses.length === 0) {
        container.innerHTML = '<p class="text-muted">No viral responses generated yet</p>';
        return;
    }
    
    let html = '';
    responses.slice(0, 5).forEach(response => {
        html += `
            <div class="response-preview">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6><i class="fas fa-music"></i> Response to: ${response.title}</h6>
                        <small class="text-muted">Platform: ${response.platform} | Genre: ${response.genre}</small>
                    </div>
                    <div class="response-meta">
                        <span class="success-rating rating-${response.success_rating}">${response.success_rating}</span>
                        <span class="viral-score">Viral: ${(response.viral_coefficient * 100).toFixed(0)}%</span>
                    </div>
                </div>
                <div class="mt-2">
                    <small>Generated: ${formatTime(response.created_at)}</small>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Show trend details modal
function showTrendDetails(trackId) {
    const trend = hijackerData.recent_trends.find(t => t.track_id === trackId);
    if (!trend) return;
    
    currentTrend = trend;
    
    const modal = new bootstrap.Modal(document.getElementById('hijackModal'));
    document.getElementById('hijackModalTitle').textContent = `Hijack Opportunity: ${trend.title}`;
    
    document.getElementById('hijackModalBody').innerHTML = `
        <div class="trend-details">
            <h6>Trend Analysis</h6>
            <div class="row mb-3">
                <div class="col-md-6">
                    <strong>Platform:</strong> ${trend.platform}<br>
                    <strong>Genre:</strong> ${trend.genre}<br>
                    <strong>Mood:</strong> ${trend.mood}<br>
                    <strong>Tempo:</strong> ${trend.tempo_bpm} BPM
                </div>
                <div class="col-md-6">
                    <strong>Views:</strong> ${trend.view_count.toLocaleString()}<br>
                    <strong>Growth Rate:</strong> ${trend.growth_rate.toFixed(1)}x<br>
                    <strong>Detected:</strong> ${formatTime(trend.detected_at)}<br>
                    <strong>Status:</strong> ${formatStatus(trend.hijack_status)}
                </div>
            </div>
            
            <h6>Hijack Potential</h6>
            <div class="metrics-grid mb-3">
                <div class="metric-card">
                    <div class="metric-value">${(trend.viral_score * 100).toFixed(0)}%</div>
                    <div class="metric-label">Viral Score</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${(trend.opportunity_score * 100).toFixed(0)}%</div>
                    <div class="metric-label">Opportunity Score</div>
                </div>
            </div>
            
            <div class="alert alert-info">
                <strong>Estimated Results:</strong><br>
                â€¢ Expected Views (24h): ${(trend.view_count * 0.1).toLocaleString()}<br>
                â€¢ Estimated Revenue: $${(trend.view_count * 0.002).toFixed(0)}<br>
                â€¢ Success Probability: ${((trend.viral_score + trend.opportunity_score) * 50).toFixed(0)}%
            </div>
        </div>
    `;
    
    modal.show();
}

// Initiate hijack
async function initiateHijack(trackId) {
    try {
        showHijackProgress(0, 'Initiating trend hijack...');
        
        const response = await fetch('/api/trending/hijack-trend', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ trend_id: trackId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const hijack = result.hijack_result;
            
            showHijackProgress(25, 'Analyzing trend patterns...');
            await sleep(1000);
            
            showHijackProgress(50, 'Generating inspired content...');
            await sleep(1500);
            
            showHijackProgress(75, 'Creating video and thumbnail...');
            await sleep(1000);
            
            showHijackProgress(100, 'Hijack completed successfully!');
            
            setTimeout(() => {
                document.getElementById('hijackProgress').style.display = 'none';
                showSuccess(`Trend hijacked successfully! Expected ${hijack.expected_views.toLocaleString()} views and $${hijack.expected_revenue.toFixed(0)} revenue.`);
                refreshDashboard();
                addActivityFeedItem('hijack_success', `Successfully hijacked trend: ${trackId}`);
            }, 2000);
            
        } else {
            showError('Failed to hijack trend: ' + result.error);
        }
    } catch (error) {
        showError('Error hijacking trend: ' + error.message);
    }
}

// Execute hijack from modal
function executeHijack() {
    if (currentTrend) {
        initiateHijack(currentTrend.track_id);
        bootstrap.Modal.getInstance(document.getElementById('hijackModal')).hide();
    }
}

// Show hijack progress
function showHijackProgress(percentage, status) {
    document.getElementById('hijackProgress').style.display = 'block';
    document.getElementById('hijackProgressBar').style.width = percentage + '%';
    document.getElementById('hijackProgressBar').textContent = percentage + '%';
    document.getElementById('hijackProgressStatus').textContent = status;
}

// Add activity feed item
function addActivityFeedItem(type, message) {
    const feed = document.getElementById('activityFeed');
    const timestamp = new Date().toLocaleTimeString();
    
    const item = document.createElement('div');
    item.className = 'feed-item';
    item.innerHTML = `
        <div class="feed-timestamp">${timestamp}</div>
        <div class="feed-message">${message}</div>
    `;
    
    feed.insertBefore(item, feed.firstChild);
    
    // Keep only last 20 items
    while (feed.children.length > 20) {
        feed.removeChild(feed.lastChild);
    }
}

// Utility functions
function getStatusClass(status) {
    const classes = {
        'detected': 'status-detected',
        'analyzed': 'status-analyzed', 
        'response_generated': 'status-hijacked',
        'viral': 'status-viral'
    };
    return classes[status] || 'status-detected';
}

function formatStatus(status) {
    const formats = {
        'detected': 'DETECTED',
        'analyzed': 'ANALYZED',
        'queued_rapid': 'QUEUED',
        'response_generated': 'HIJACKED',
        'viral': 'VIRAL'
    };
    return formats[status] || status.toUpperCase();
}

function getSuccessRating(status) {
    if (status === 'response_generated') return 'high';
    if (status === 'viral') return 'ultra';
    return 'medium';
}

function formatTime(timestamp) {
    return new Date(timestamp).toLocaleString();
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function showSuccess(message) {
    showAlert('success', message);
}

function showError(message) {
    showAlert('danger', message);
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

function showLoader(message) {
    console.log('Loading:', message);
}

function hideLoader() {
    console.log('Loading complete');
}

function exportHijackData() {
    const dataStr = JSON.stringify(hijackerData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = 'trending_hijacker_data.json';
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}
</script>
{% endblock %}