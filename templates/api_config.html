{% extends "admin_base.html" %}

{% block title %}API Configuration - Admin Panel{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">API Config</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-0">
            <i class="fas fa-cog text-primary me-2"></i>
            API Configuration
        </h1>
        <p class="text-muted">Configure and manage your API connections for music generation</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-outline-secondary" onclick="testAllConnections()">
            <i class="fas fa-plug me-1"></i>
            Test All
        </button>
    </div>
</div>

<!-- API Status Overview -->
<div class="row mb-4">
    <div class="col-md-4 col-sm-6 mb-3">
        <div class="card {% if api_status.suno.status == 'connected' %}border-success{% elif api_status.suno.status == 'error' %}border-danger{% else %}border-warning{% endif %}">
            <div class="card-body text-center">
                <i class="fas fa-music fa-2x {% if api_status.suno.status == 'connected' %}text-success{% elif api_status.suno.status == 'error' %}text-danger{% else %}text-warning{% endif %} mb-2"></i>
                <h6>Suno API</h6>
                <span class="status-badge 
                    {% if api_status.suno.status == 'connected' %}status-connected
                    {% elif api_status.suno.status == 'error' %}status-error
                    {% else %}status-warning{% endif %}">
                    {{ api_status.suno.status.title() }}
                </span>
                {% if api_status.suno.status == 'connected' %}
                    <div class="small text-success mt-2">{{ api_status.suno.credits }} credits</div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4 col-sm-6 mb-3">
        <div class="card {% if api_status.gemini.status == 'connected' %}border-success{% elif api_status.gemini.status == 'error' %}border-danger{% else %}border-warning{% endif %}">
            <div class="card-body text-center">
                <i class="fas fa-brain fa-2x {% if api_status.gemini.status == 'connected' %}text-success{% elif api_status.gemini.status == 'error' %}text-danger{% else %}text-warning{% endif %} mb-2"></i>
                <h6>Gemini AI</h6>
                <span class="status-badge 
                    {% if api_status.gemini.status == 'connected' %}status-connected
                    {% elif api_status.gemini.status == 'error' %}status-error
                    {% else %}status-warning{% endif %}">
                    {{ api_status.gemini.status.title() }}
                </span>
                {% if api_status.gemini.status == 'connected' %}
                    <div class="small text-success mt-2">{{ api_status.gemini.model }}</div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4 col-sm-6 mb-3">
        <div class="card {% if api_status.nano_banana.status == 'connected' %}border-success{% elif api_status.nano_banana.status == 'error' %}border-danger{% else %}border-warning{% endif %}">
            <div class="card-body text-center">
                <i class="fas fa-image fa-2x {% if api_status.nano_banana.status == 'connected' %}text-success{% elif api_status.nano_banana.status == 'error' %}text-danger{% else %}text-warning{% endif %} mb-2"></i>
                <h6>üçå Nano-Banana</h6>
                <span class="status-badge 
                    {% if api_status.nano_banana.status == 'connected' %}status-connected
                    {% elif api_status.nano_banana.status == 'error' %}status-error
                    {% else %}status-warning{% endif %}">
                    {{ api_status.nano_banana.status.title() }}
                </span>
                {% if api_status.nano_banana.status == 'connected' %}
                    <div class="small text-success mt-2">{{ api_status.nano_banana.model }}</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Configuration Forms -->
<div class="row">
    <!-- Suno API Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-music text-primary me-2"></i>
                Suno API Configuration
            </div>
            <div class="card-body">
                <form id="sunoConfigForm">
                    <div class="mb-3">
                        <label for="sunoApiKey" class="form-label">API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="sunoApiKey" 
                                   placeholder="Enter your Suno API key"
                                   {% if env_config.SUNO_API_KEY != 'not_configured' %}
                                   data-configured="true" 
                                   data-masked-value="{{ env_config.SUNO_API_KEY }}"
                                   value="{{ env_config.SUNO_API_KEY }}"
                                   readonly
                                   {% else %}
                                   value=""
                                   {% endif %}>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('sunoApiKey')">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if env_config.SUNO_API_KEY != 'not_configured' %}
                            <button class="btn btn-outline-primary" type="button" onclick="editApiKey('sunoApiKey')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            {% endif %}
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Get your API key from <a href="https://api.sunoapi.org" target="_blank">api.sunoapi.org</a>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sunoModel" class="form-label">Preferred Model</label>
                        <select class="form-select" id="sunoModel">
                            <option value="V4_5" {% if env_config.SUNO_MODEL == 'V4_5' %}selected{% endif %}>V4.5 - Superior genre blending, up to 8 min ‚ö°</option>
                            <option value="V4" {% if env_config.SUNO_MODEL == 'V4' or not env_config.SUNO_MODEL or env_config.SUNO_MODEL == 'not_configured' %}selected{% endif %}>V4 - Best audio quality, up to 4 min ‚ú®</option>
                            <option value="V3_5" {% if env_config.SUNO_MODEL == 'V3_5' %}selected{% endif %}>V3.5 - Solid arrangements, up to 4 min üéµ</option>
                        </select>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-primary" onclick="testConnection('suno')">
                            <i class="fas fa-plug me-1"></i>
                            Test Connection
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            Save Configuration
                        </button>
                    </div>
                </form>
                
                <!-- Usage Stats -->
                {% if api_status.suno.status == 'connected' %}
                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="mb-2">Current Usage</h6>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Credits Remaining</small>
                            <div class="fw-bold text-success">{{ api_status.suno.credits }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Rate Limit</small>
                            <div class="fw-bold">20/10s</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Gemini AI Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-brain text-info me-2"></i>
                Gemini AI Configuration
            </div>
            <div class="card-body">
                <form id="geminiConfigForm">
                    <div class="mb-3">
                        <label for="geminiApiKey" class="form-label">API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="geminiApiKey" 
                                   placeholder="Enter your Gemini API key"
                                   {% if env_config.GEMINI_API_KEY != 'not_configured' %}
                                   data-configured="true" 
                                   data-masked-value="{{ env_config.GEMINI_API_KEY }}"
                                   value="{{ env_config.GEMINI_API_KEY }}"
                                   readonly
                                   {% else %}
                                   value=""
                                   {% endif %}>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('geminiApiKey')">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if env_config.GEMINI_API_KEY != 'not_configured' %}
                            <button class="btn btn-outline-primary" type="button" onclick="editApiKey('geminiApiKey')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            {% endif %}
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="geminiModel" class="form-label">Model</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="geminiModel" value="gemini-2.5-flash" readonly disabled>
                            <span class="input-group-text bg-success text-white">
                                <i class="fas fa-lock me-1"></i>
                                LATEST ‚ö°
                            </span>
                        </div>
                        <div class="form-text text-success">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Fixed Model:</strong> gemini-2.5-flash is the newest and most advanced version. 
                            This model cannot be changed as it provides the best performance and latest features.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="geminiTemp" class="form-label">Temperature</label>
                        <input type="range" class="form-range" id="geminiTemp" min="0" max="2" step="0.1" value="1.0">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Conservative</small>
                            <small class="text-muted">Creative</small>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-info" onclick="testConnection('gemini')">
                            <i class="fas fa-plug me-1"></i>
                            Test Connection
                        </button>
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-save me-1"></i>
                            Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Second Row -->
<div class="row">
    <!-- Gemini Nano-Banana Image Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-image text-success me-2"></i>
                üçå Nano-Banana Image Generation
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <i class="fas fa-magic me-2"></i>
                    <strong>üöÄ Powered by Gemini 2.5 Flash Image!</strong><br>
                    Uses your existing Gemini API key - no additional setup needed!<br>
                    <small>‚ú® Features: Character consistency, multi-image fusion, prompt-based editing, world knowledge integration</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Model Details</label>
                    <div class="p-3 bg-light rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Model:</strong> gemini-2.5-flash-image-preview<br>
                                <strong>Resolution:</strong> 1024x1024 pixels<br>
                                <strong>Cost:</strong> $0.039 per image
                            </div>
                            <div class="col-md-6">
                                <strong>Features:</strong><br>
                                ‚Ä¢ Character consistency<br>
                                ‚Ä¢ Multi-image fusion<br>
                                ‚Ä¢ Prompt-based editing<br>
                                ‚Ä¢ World knowledge integration
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>How it works:</strong> Nano-banana automatically uses your Gemini API key for image generation. 
                    Just ensure your Gemini API is configured above and you're ready to generate professional album covers!
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" class="btn btn-outline-success" onclick="testNanaBanana()">
                        <i class="fas fa-magic me-1"></i>
                        Test Nano-Banana
                    </button>
                    <a href="https://ai.google.dev/gemini-api/docs/vision" target="_blank" class="btn btn-success">
                        <i class="fas fa-external-link-alt me-1"></i>
                        Documentation
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Settings -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-sliders-h text-secondary me-2"></i>
                Advanced Settings
            </div>
            <div class="card-body">
                <form id="advancedConfigForm">
                    <div class="mb-3">
                        <label for="requestTimeout" class="form-label">Request Timeout (seconds)</label>
                        <input type="number" class="form-control" id="requestTimeout" 
                               min="10" max="300" value="60">
                    </div>
                    
                    <div class="mb-3">
                        <label for="maxRetries" class="form-label">Max Retries</label>
                        <input type="number" class="form-control" id="maxRetries" 
                               min="1" max="10" value="3">
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableCache" checked>
                            <label class="form-check-label" for="enableCache">
                                Enable Response Caching
                            </label>
                        </div>
                        <div class="form-text">Caches similar requests to reduce API calls</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableFallback" checked>
                            <label class="form-check-label" for="enableFallback">
                                Enable Mock Fallback
                            </label>
                        </div>
                        <div class="form-text">Use mock data if APIs fail</div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-secondary">
                            <i class="fas fa-save me-1"></i>
                            Save Advanced Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Documentation Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-book text-info me-2"></i>
                API Documentation & Help
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-music text-primary me-2"></i>Suno API</h6>
                        <ul class="list-unstyled">
                            <li><strong>Purpose:</strong> Music generation</li>
                            <li><strong>Cost:</strong> ~5-10 credits per song</li>
                            <li><strong>Limits:</strong> 20 requests/10 seconds</li>
                        </ul>
                        <a href="https://api.sunoapi.org/docs" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>
                            Documentation
                        </a>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-brain text-info me-2"></i>Gemini AI</h6>
                        <ul class="list-unstyled">
                            <li><strong>Purpose:</strong> Text generation</li>
                            <li><strong>Cost:</strong> ~$0.001-0.01 per request</li>
                            <li><strong>Limits:</strong> Varies by plan</li>
                        </ul>
                        <a href="https://ai.google.dev/docs" target="_blank" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>
                            Documentation
                        </a>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-image text-success me-2"></i>üçå Nano-Banana</h6>
                        <ul class="list-unstyled">
                            <li><strong>Purpose:</strong> AI Image generation & editing</li>
                            <li><strong>Cost:</strong> $0.039 per image</li>
                            <li><strong>Features:</strong> Character consistency, fusion</li>
                            <li><strong>Model:</strong> gemini-2.5-flash-image</li>
                        </ul>
                        <a href="https://ai.google.dev/gemini-api/docs/vision" target="_blank" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>
                            Documentation
                        </a>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-light rounded">
                    <h6><i class="fas fa-lightbulb text-warning me-2"></i>Quick Tips</h6>
                    <ul class="mb-0">
                        <li>Start with test mode to familiarize yourself with the system</li>
                        <li>Configure Suno and Gemini APIs for full functionality</li>
                        <li>Nano-banana image generation uses your Gemini API key</li>
                        <li>Monitor your usage to avoid unexpected costs</li>
                        <li>Keep your API keys secure and never share them</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // API Configuration JavaScript
    
    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling;
        const icon = button.querySelector('i');
        
        if (field.type === 'password') {
            field.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            field.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }
    
    function testConnection(service) {
        const button = event.target;
        const originalText = button.innerHTML;
        
        showLoading(button);
        
        // Collect API key for testing
        let testData = { service: service };
        
        if (service === 'suno') {
            const apiKey = document.getElementById('sunoApiKey').value.trim();
            if (!apiKey) {
                hideLoading(button, originalText);
                showToast('Please enter Suno API key first', 'warning');
                return;
            }
            testData.api_key = apiKey;
            
        } else if (service === 'gemini') {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            const model = document.getElementById('geminiModel').value;
            if (!apiKey) {
                hideLoading(button, originalText);
                showToast('Please enter Gemini API key first', 'warning');
                return;
            }
            testData.api_key = apiKey;
            testData.model = model;
            
        } else if (service === 'nano_banana') {
            // Nano-banana uses Gemini API key
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            if (!geminiKey) {
                hideLoading(button, originalText);
                showToast('Nano-banana requires Gemini API key. Please configure Gemini first.', 'warning');
                return;
            }
            hideLoading(button, originalText);
            showToast('Nano-banana ready! Uses your Gemini API key.', 'success');
            return;
        }
        
        // Test the API connection
        fetch('/api/config/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin', // Include session cookies
            body: JSON.stringify(testData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(button, originalText);
            
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(`Connection failed: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            hideLoading(button, originalText);
            console.error('Test error:', error);
            showToast('Connection test failed. Please check your API key.', 'error');
        });
    }
    
    function testAllConnections() {
        const services = ['suno', 'gemini', 'nano_banana'];
        let tested = 0;
        
        Swal.fire({
            title: 'Testing All Connections',
            html: '<div class="progress"><div class="progress-bar" role="progressbar" style="width: 0%"></div></div>',
            allowOutsideClick: false,
            showConfirmButton: false
        });
        
        services.forEach((service, index) => {
            setTimeout(() => {
                tested++;
                const progress = (tested / services.length) * 100;
                document.querySelector('.progress-bar').style.width = progress + '%';
                
                if (tested === services.length) {
                    Swal.close();
                    showToast('All API connections tested!', 'success');
                }
            }, (index + 1) * 1000);
        });
    }
    
    // Form submissions
    document.getElementById('sunoConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveConfiguration('suno');
    });
    
    document.getElementById('geminiConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveConfiguration('gemini');
    });
    
    // Nano-banana uses Gemini API key - no separate form needed
    
    document.getElementById('advancedConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveConfiguration('advanced');
    });
    
    function saveConfiguration(service) {
        const button = event.target.querySelector('button[type="submit"]');
        const originalText = button.innerHTML;
        
        showLoading(button);
        
        // Collect form data based on service
        let configData = {};
        
        if (service === 'suno') {
            const sunoKey = document.getElementById('sunoApiKey').value.trim();
            const sunoModel = document.getElementById('sunoModel').value;
            
            if (!sunoKey) {
                hideLoading(button, originalText);
                showToast('Please enter Suno API key', 'warning');
                return;
            }
            
            configData = {
                suno_api_key: sunoKey,
                suno_model: sunoModel
            };
            
        } else if (service === 'gemini') {
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            const geminiModel = document.getElementById('geminiModel').value;
            
            if (!geminiKey) {
                hideLoading(button, originalText);
                showToast('Please enter Gemini API key', 'warning');
                return;
            }
            
            configData = {
                gemini_api_key: geminiKey,
                gemini_model: geminiModel
            };
            
        } else if (service === 'advanced') {
            // Handle advanced settings
            hideLoading(button, originalText);
            showToast('Advanced settings saved!', 'success');
            return;
        }
        
        // Send to real API endpoint
        console.log('üöÄ Sending config data:', configData);
        
        fetch('/api/config/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin', // Include session cookies
            body: JSON.stringify(configData)
        })
        .then(response => {
            console.log('üì® Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üì© Response data:', data);
            hideLoading(button, originalText);
            
            if (data.success) {
                showToast(`${service.charAt(0).toUpperCase() + service.slice(1)} configuration saved successfully!`, 'success');
                
                // Reload page to show updated API status
                setTimeout(() => {
                    console.log('üîÑ Reloading page to show updated API status...');
                    window.location.reload();
                }, 1500);
            } else {
                console.error('‚ùå Save failed:', data.error);
                showToast(`Error: ${data.error || 'Failed to save configuration'}`, 'error');
            }
        })
        .catch(error => {
            hideLoading(button, originalText);
            console.error('Save error:', error);
            showToast('Failed to save configuration. Please try again.', 'error');
        });
    }
    
    // Temperature slider update
    document.getElementById('geminiTemp').addEventListener('input', function() {
        const value = this.value;
        this.title = `Temperature: ${value}`;
    });
    
    // Initialize tooltips
    const temperatureSlider = document.getElementById('geminiTemp');
    temperatureSlider.title = `Temperature: ${temperatureSlider.value}`;
    
    // Nano-banana test function
    function testNanaBanana() {
        const geminiKey = document.getElementById('geminiApiKey').value;
        if (!geminiKey || geminiKey === 'configured') {
            Swal.fire({
                icon: 'warning',
                title: 'üçå Nano-banana Test',
                text: 'Please configure your Gemini API key first to test image generation.',
                confirmButtonText: 'Configure Gemini'
            });
            return;
        }
        
        Swal.fire({
            icon: 'success',
            title: 'üçå Nano-banana Ready!',
            html: `
                <div class="alert alert-success">
                    <strong>‚úÖ Gemini 2.5 Flash Image is ready!</strong><br>
                    Your existing Gemini API key will be used for:<br><br>
                    üé® Professional album cover generation<br>
                    üñºÔ∏è YouTube thumbnail creation<br>
                    ‚ú® Character consistency<br>
                    üîÄ Multi-image fusion<br>
                    üìù Prompt-based editing
                </div>
                <p><small>üí∞ Cost: $0.039 per image (Gemini 2.5 Flash Image - nano-banana model)</small></p>
            `,
            confirmButtonText: 'Awesome! üöÄ'
        });
    }
    
    // Function to edit API key
    function editApiKey(inputId) {
        const input = document.getElementById(inputId);
        const editBtn = input.parentElement.querySelector('.btn-outline-primary');
        
        if (input.hasAttribute('readonly')) {
            // Enable editing
            input.removeAttribute('readonly');
            input.value = ''; // Clear for new input
            input.focus();
            input.placeholder = 'Enter new API key';
            editBtn.innerHTML = '<i class="fas fa-save"></i> Save';
            editBtn.onclick = () => saveApiKeyEdit(inputId);
        }
    }
    
    function saveApiKeyEdit(inputId) {
        const input = document.getElementById(inputId);
        const newKey = input.value.trim();
        
        if (!newKey) {
            showToast('Please enter a valid API key', 'warning');
            return;
        }
        
        // Determine service type and save
        const service = inputId.includes('suno') ? 'suno' : 'gemini';
        
        // Prepare config data
        let configData = {};
        if (service === 'suno') {
            configData.suno_api_key = newKey;
        } else {
            configData.gemini_api_key = newKey;
            configData.gemini_model = document.getElementById('geminiModel').value;
        }
        
        // Save the configuration
        console.log('üöÄ Saving edited API key:', { service, configData });
        
        fetch('/api/config/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify(configData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('API key updated successfully!', 'success');
                
                // Reload page to show updated values
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast(`Error: ${data.error || 'Failed to save API key'}`, 'error');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            showToast('Failed to save API key. Please try again.', 'error');
        });
    }
</script>
{% endblock %}