{% extends "admin_base.html" %}

{% block title %}API Configuration - Admin Panel{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">API Config</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-0">
            <i class="fas fa-cog text-primary me-2"></i>
            API Configuration
        </h1>
        <p class="text-muted">Configure and manage your API connections for music generation</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-outline-secondary" onclick="testAllConnections()">
            <i class="fas fa-plug me-1"></i>
            Test All
        </button>
    </div>
</div>

<!-- API Status Overview -->
<div class="row mb-4">
    <div class="col-md-4 col-sm-6 mb-3">
        <div class="card {% if api_status.suno.status == 'connected' %}border-success{% elif api_status.suno.status == 'error' %}border-danger{% else %}border-warning{% endif %}">
            <div class="card-body text-center">
                <i class="fas fa-music fa-2x {% if api_status.suno.status == 'connected' %}text-success{% elif api_status.suno.status == 'error' %}text-danger{% else %}text-warning{% endif %} mb-2"></i>
                <h6>Suno API</h6>
                <span class="status-badge 
                    {% if api_status.suno.status == 'connected' %}status-connected
                    {% elif api_status.suno.status == 'error' %}status-error
                    {% else %}status-warning{% endif %}">
                    {{ api_status.suno.status.title() }}
                </span>
                {% if api_status.suno.status == 'connected' %}
                    <div class="small text-success mt-2">{{ api_status.suno.credits }} credits</div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4 col-sm-6 mb-3">
        <div class="card {% if api_status.gemini.status == 'connected' %}border-success{% elif api_status.gemini.status == 'error' %}border-danger{% else %}border-warning{% endif %}">
            <div class="card-body text-center">
                <i class="fas fa-brain fa-2x {% if api_status.gemini.status == 'connected' %}text-success{% elif api_status.gemini.status == 'error' %}text-danger{% else %}text-warning{% endif %} mb-2"></i>
                <h6>Gemini AI</h6>
                <span class="status-badge 
                    {% if api_status.gemini.status == 'connected' %}status-connected
                    {% elif api_status.gemini.status == 'error' %}status-error
                    {% else %}status-warning{% endif %}">
                    {{ api_status.gemini.status.title() }}
                </span>
                {% if api_status.gemini.status == 'connected' %}
                    <div class="small text-success mt-2">{{ api_status.gemini.model }}</div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4 col-sm-6 mb-3">
        <div class="card {% if api_status.ideogram.status == 'connected' %}border-success{% elif api_status.ideogram.status == 'error' %}border-danger{% else %}border-warning{% endif %}">
            <div class="card-body text-center">
                <i class="fas fa-image fa-2x {% if api_status.ideogram.status == 'connected' %}text-success{% elif api_status.ideogram.status == 'error' %}text-danger{% else %}text-warning{% endif %} mb-2"></i>
                <h6>ðŸŽ¨ Ideogram 3.0</h6>
                <span class="status-badge 
                    {% if api_status.ideogram.status == 'connected' %}status-connected
                    {% elif api_status.ideogram.status == 'error' %}status-error
                    {% else %}status-warning{% endif %}">
                    {{ api_status.ideogram.status.title() }}
                </span>
                {% if api_status.ideogram.status == 'connected' %}
                    <div class="small text-success mt-2">{{ api_status.ideogram.model }}</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Configuration Forms -->
<div class="row">
    <!-- Suno API Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-music text-primary me-2"></i>
                Suno API Configuration
            </div>
            <div class="card-body">
                <form id="sunoConfigForm">
                    <div class="mb-3">
                        <label for="sunoApiKey" class="form-label">API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="sunoApiKey" 
                                   placeholder="Enter your Suno API key"
                                   {% if env_config.SUNO_API_KEY != 'not_configured' %}
                                   data-configured="true" 
                                   data-masked-value="{{ env_config.SUNO_API_KEY }}"
                                   value="{{ env_config.SUNO_API_KEY }}"
                                   readonly
                                   {% else %}
                                   value=""
                                   {% endif %}>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('sunoApiKey')">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if env_config.SUNO_API_KEY != 'not_configured' %}
                            <button class="btn btn-outline-primary" type="button" onclick="editApiKey('sunoApiKey')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            {% endif %}
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Get your API key from <a href="https://api.sunoapi.org" target="_blank">api.sunoapi.org</a>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sunoModel" class="form-label">Preferred Model</label>
                        <select class="form-select" id="sunoModel">
                            <option value="V4_5" {% if env_config.SUNO_MODEL == 'V4_5' %}selected{% endif %}>V4.5 - Superior genre blending, up to 8 min âš¡</option>
                            <option value="V4" {% if env_config.SUNO_MODEL == 'V4' or not env_config.SUNO_MODEL or env_config.SUNO_MODEL == 'not_configured' %}selected{% endif %}>V4 - Best audio quality, up to 4 min âœ¨</option>
                            <option value="V3_5" {% if env_config.SUNO_MODEL == 'V3_5' %}selected{% endif %}>V3.5 - Solid arrangements, up to 4 min ðŸŽµ</option>
                        </select>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-primary" onclick="testConnection('suno')">
                            <i class="fas fa-plug me-1"></i>
                            Test Connection
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            Save Configuration
                        </button>
                    </div>
                </form>
                
                <!-- Usage Stats -->
                {% if api_status.suno.status == 'connected' %}
                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="mb-2">Current Usage</h6>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Credits Remaining</small>
                            <div class="fw-bold text-success">{{ api_status.suno.credits }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Rate Limit</small>
                            <div class="fw-bold">20/10s</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Gemini AI Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-brain text-info me-2"></i>
                Gemini AI Configuration
            </div>
            <div class="card-body">
                <form id="geminiConfigForm">
                    <div class="mb-3">
                        <label for="geminiApiKey" class="form-label">API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="geminiApiKey" 
                                   placeholder="Enter your Gemini API key"
                                   {% if env_config.GEMINI_API_KEY != 'not_configured' %}
                                   data-configured="true" 
                                   data-masked-value="{{ env_config.GEMINI_API_KEY }}"
                                   value="{{ env_config.GEMINI_API_KEY }}"
                                   readonly
                                   {% else %}
                                   value=""
                                   {% endif %}>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('geminiApiKey')">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if env_config.GEMINI_API_KEY != 'not_configured' %}
                            <button class="btn btn-outline-primary" type="button" onclick="editApiKey('geminiApiKey')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            {% endif %}
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="geminiModel" class="form-label">Model</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="geminiModel" value="gemini-2.5-flash" readonly disabled>
                            <span class="input-group-text bg-success text-white">
                                <i class="fas fa-lock me-1"></i>
                                LATEST âš¡
                            </span>
                        </div>
                        <div class="form-text text-success">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Fixed Model:</strong> gemini-2.5-flash is the newest and most advanced version. 
                            This model cannot be changed as it provides the best performance and latest features.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="geminiTemp" class="form-label">Temperature</label>
                        <input type="range" class="form-range" id="geminiTemp" min="0" max="2" step="0.1" value="1.0">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Conservative</small>
                            <small class="text-muted">Creative</small>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-info" onclick="testConnection('gemini')">
                            <i class="fas fa-plug me-1"></i>
                            Test Connection
                        </button>
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-save me-1"></i>
                            Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Second Row -->
<div class="row">
    <!-- Ideogram 3.0 Image Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-image text-success me-2"></i>
                ðŸŽ¨ Ideogram 3.0 Image Generation
            </div>
            <div class="card-body">
                <form id="ideogramConfigForm">
                    <div class="mb-3">
                        <label for="ideogramApiKey" class="form-label">Ideogram API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="ideogramApiKey" 
                                   placeholder="Enter your Ideogram API key"
                                   {% if env_config.IDEOGRAM_API_KEY != 'not_configured' %}
                                   data-configured="true" 
                                   data-masked-value="{{ env_config.IDEOGRAM_API_KEY }}"
                                   value="{{ env_config.IDEOGRAM_API_KEY }}"
                                   readonly
                                   {% else %}
                                   value=""
                                   {% endif %}>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('ideogramApiKey')">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if env_config.IDEOGRAM_API_KEY != 'not_configured' %}
                            <button class="btn btn-outline-primary" type="button" onclick="editApiKey('ideogramApiKey')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            {% endif %}
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Get your API key from <a href="https://ideogram.ai/api" target="_blank">Ideogram API Console</a>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ideogramRenderingSpeed" class="form-label">Rendering Speed</label>
                        <select class="form-select" id="ideogramRenderingSpeed">
                            <option value="TURBO" {% if env_config.IDEOGRAM_RENDERING_SPEED == 'TURBO' or not env_config.IDEOGRAM_RENDERING_SPEED %}selected{% endif %}>TURBO - Fast generation (recommended) âš¡</option>
                            <option value="STANDARD" {% if env_config.IDEOGRAM_RENDERING_SPEED == 'STANDARD' %}selected{% endif %}>STANDARD - Balanced quality and speed ðŸŽ¯</option>
                            <option value="SLOW" {% if env_config.IDEOGRAM_RENDERING_SPEED == 'SLOW' %}selected{% endif %}>SLOW - Best quality, slower generation âœ¨</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ideogramStyleType" class="form-label">Style Type</label>
                        <select class="form-select" id="ideogramStyleType">
                            <option value="GENERAL" {% if env_config.IDEOGRAM_STYLE_TYPE == 'GENERAL' or not env_config.IDEOGRAM_STYLE_TYPE %}selected{% endif %}>GENERAL - Versatile style (default) ðŸŽ¨</option>
                            <option value="REALISTIC" {% if env_config.IDEOGRAM_STYLE_TYPE == 'REALISTIC' %}selected{% endif %}>REALISTIC - Photorealistic images ðŸ“¸</option>
                            <option value="DESIGN" {% if env_config.IDEOGRAM_STYLE_TYPE == 'DESIGN' %}selected{% endif %}>DESIGN - Graphic design style ðŸŽ¯</option>
                            <option value="RENDER_3D" {% if env_config.IDEOGRAM_STYLE_TYPE == 'RENDER_3D' %}selected{% endif %}>RENDER_3D - 3D rendered style ðŸ”®</option>
                            <option value="ANIME" {% if env_config.IDEOGRAM_STYLE_TYPE == 'ANIME' %}selected{% endif %}>ANIME - Anime/manga style ðŸŒ¸</option>
                        </select>
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="fas fa-magic me-2"></i>
                        <strong>ðŸš€ Ideogram 3.0 - Professional AI Image Generation</strong><br>
                        High-quality, consistent results with advanced prompt understanding<br>
                        <small>âœ¨ Features: Text rendering, style consistency, aspect ratio control, professional quality</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Model Details</label>
                        <div class="p-3 bg-light rounded">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Model:</strong> ideogram-v3<br>
                                    <strong>Resolution:</strong> Up to 1024x1024<br>
                                    <strong>Aspect Ratios:</strong> 16:9, 1:1, 9:16
                                </div>
                                <div class="col-md-6">
                                    <strong>Features:</strong><br>
                                    â€¢ Superior text rendering<br>
                                    â€¢ Style consistency<br>
                                    â€¢ Advanced prompt understanding<br>
                                    â€¢ Professional quality output
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-success" onclick="testConnection('ideogram')">
                            <i class="fas fa-magic me-1"></i>
                            Test Ideogram
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>
                            Save Configuration
                        </button>
                    </div>
                </form>
                
                <div class="mt-3">
                    <a href="https://ideogram.ai/api/docs" target="_blank" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-external-link-alt me-1"></i>
                        API Documentation
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Settings -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-sliders-h text-secondary me-2"></i>
                Advanced Settings
            </div>
            <div class="card-body">
                <form id="advancedConfigForm">
                    <div class="mb-3">
                        <label for="requestTimeout" class="form-label">Request Timeout (seconds)</label>
                        <input type="number" class="form-control" id="requestTimeout" 
                               min="10" max="300" value="60">
                    </div>
                    
                    <div class="mb-3">
                        <label for="maxRetries" class="form-label">Max Retries</label>
                        <input type="number" class="form-control" id="maxRetries" 
                               min="1" max="10" value="3">
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableCache" checked>
                            <label class="form-check-label" for="enableCache">
                                Enable Response Caching
                            </label>
                        </div>
                        <div class="form-text">Caches similar requests to reduce API calls</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableFallback" checked>
                            <label class="form-check-label" for="enableFallback">
                                Enable Mock Fallback
                            </label>
                        </div>
                        <div class="form-text">Use mock data if APIs fail</div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-secondary">
                            <i class="fas fa-save me-1"></i>
                            Save Advanced Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Documentation Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-book text-info me-2"></i>
                API Documentation & Help
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-music text-primary me-2"></i>Suno API</h6>
                        <ul class="list-unstyled">
                            <li><strong>Purpose:</strong> Music generation</li>
                            <li><strong>Cost:</strong> ~5-10 credits per song</li>
                            <li><strong>Limits:</strong> 20 requests/10 seconds</li>
                        </ul>
                        <a href="https://api.sunoapi.org/docs" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>
                            Documentation
                        </a>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-brain text-info me-2"></i>Gemini AI</h6>
                        <ul class="list-unstyled">
                            <li><strong>Purpose:</strong> Text generation</li>
                            <li><strong>Cost:</strong> ~$0.001-0.01 per request</li>
                            <li><strong>Limits:</strong> Varies by plan</li>
                        </ul>
                        <a href="https://ai.google.dev/docs" target="_blank" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>
                            Documentation
                        </a>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-image text-success me-2"></i>ðŸŽ¨ Ideogram 3.0</h6>
                        <ul class="list-unstyled">
                            <li><strong>Purpose:</strong> Professional AI image generation</li>
                            <li><strong>Features:</strong> Text rendering, style consistency</li>
                            <li><strong>Model:</strong> ideogram-v3</li>
                            <li><strong>Quality:</strong> Superior prompt understanding</li>
                        </ul>
                        <a href="https://ideogram.ai/api/docs" target="_blank" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>
                            Documentation
                        </a>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-light rounded">
                    <h6><i class="fas fa-lightbulb text-warning me-2"></i>Quick Tips</h6>
                    <ul class="mb-0">
                        <li>Start with test mode to familiarize yourself with the system</li>
                        <li>Configure Suno and Gemini APIs for full functionality</li>
                        <li>Ideogram 3.0 provides superior text rendering and style consistency</li>
                        <li>Monitor your usage to avoid unexpected costs</li>
                        <li>Keep your API keys secure and never share them</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // API Configuration JavaScript
    
    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling;
        const icon = button.querySelector('i');
        
        if (field.type === 'password') {
            field.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            field.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }
    
    function testConnection(service) {
        const button = event.target;
        const originalText = button.innerHTML;
        
        showLoading(button);
        
        // Collect API key for testing
        let testData = { service: service };
        
        if (service === 'suno') {
            const apiKey = document.getElementById('sunoApiKey').value.trim();
            if (!apiKey) {
                hideLoading(button, originalText);
                showToast('Please enter Suno API key first', 'warning');
                return;
            }
            testData.api_key = apiKey;
            
        } else if (service === 'gemini') {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            const model = document.getElementById('geminiModel').value;
            if (!apiKey) {
                hideLoading(button, originalText);
                showToast('Please enter Gemini API key first', 'warning');
                return;
            }
            testData.api_key = apiKey;
            testData.model = model;
            

        } else if (service === 'ideogram') {
            const apiKey = document.getElementById('ideogramApiKey').value.trim();
            if (!apiKey) {
                hideLoading(button, originalText);
                showToast('Please enter Ideogram API key first', 'warning');
                return;
            }
            testData.api_key = apiKey;
        }
        
        // Test the API connection
        fetch('/api/config/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin', // Include session cookies
            body: JSON.stringify(testData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(button, originalText);
            
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(`Connection failed: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            hideLoading(button, originalText);
            console.error('Test error:', error);
            showToast('Connection test failed. Please check your API key.', 'error');
        });
    }
    
    function testAllConnections() {
        const services = ['suno', 'gemini', 'ideogram'];
        let tested = 0;
        
        Swal.fire({
            title: 'Testing All Connections',
            html: '<div class="progress"><div class="progress-bar" role="progressbar" style="width: 0%"></div></div>',
            allowOutsideClick: false,
            showConfirmButton: false
        });
        
        services.forEach((service, index) => {
            setTimeout(() => {
                tested++;
                const progress = (tested / services.length) * 100;
                document.querySelector('.progress-bar').style.width = progress + '%';
                
                if (tested === services.length) {
                    Swal.close();
                    showToast('All API connections tested!', 'success');
                }
            }, (index + 1) * 1000);
        });
    }
    
    // Form submissions
    document.getElementById('sunoConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveConfiguration('suno');
    });
    
    document.getElementById('geminiConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveConfiguration('gemini');
    });
    
    document.getElementById('ideogramConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveConfiguration('ideogram');
    });
    
    document.getElementById('advancedConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveConfiguration('advanced');
    });
    
    function saveConfiguration(service) {
        const button = event.target.querySelector('button[type="submit"]');
        const originalText = button.innerHTML;
        
        showLoading(button);
        
        // Collect form data based on service
        let configData = {};
        
        if (service === 'suno') {
            const sunoKey = document.getElementById('sunoApiKey').value.trim();
            const sunoModel = document.getElementById('sunoModel').value;
            
            if (!sunoKey) {
                hideLoading(button, originalText);
                showToast('Please enter Suno API key', 'warning');
                return;
            }
            
            configData = {
                suno_api_key: sunoKey,
                suno_model: sunoModel
            };
            
        } else if (service === 'gemini') {
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            const geminiModel = document.getElementById('geminiModel').value;
            
            if (!geminiKey) {
                hideLoading(button, originalText);
                showToast('Please enter Gemini API key', 'warning');
                return;
            }
            
            configData = {
                gemini_api_key: geminiKey,
                gemini_model: geminiModel
            };
            
        } else if (service === 'ideogram') {
            const ideogramKey = document.getElementById('ideogramApiKey').value.trim();
            const renderingSpeed = document.getElementById('ideogramRenderingSpeed').value;
            const styleType = document.getElementById('ideogramStyleType').value;
            
            if (!ideogramKey) {
                hideLoading(button, originalText);
                showToast('Please enter Ideogram API key', 'warning');
                return;
            }
            
            configData = {
                ideogram_api_key: ideogramKey,
                ideogram_rendering_speed: renderingSpeed,
                ideogram_style_type: styleType
            };
            
        } else if (service === 'advanced') {
            // Handle advanced settings
            hideLoading(button, originalText);
            showToast('Advanced settings saved!', 'success');
            return;
        }
        
        // Send to real API endpoint
        console.log('ðŸš€ Sending config data:', configData);
        
        fetch('/api/config/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin', // Include session cookies
            body: JSON.stringify(configData)
        })
        .then(response => {
            console.log('ðŸ“¨ Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('ðŸ“© Response data:', data);
            hideLoading(button, originalText);
            
            if (data.success) {
                showToast(`${service.charAt(0).toUpperCase() + service.slice(1)} configuration saved successfully!`, 'success');
                
                // Reload page to show updated API status
                setTimeout(() => {
                    console.log('ðŸ”„ Reloading page to show updated API status...');
                    window.location.reload();
                }, 1500);
            } else {
                console.error('âŒ Save failed:', data.error);
                showToast(`Error: ${data.error || 'Failed to save configuration'}`, 'error');
            }
        })
        .catch(error => {
            hideLoading(button, originalText);
            console.error('Save error:', error);
            showToast('Failed to save configuration. Please try again.', 'error');
        });
    }
    
    // Setup OAuth guide function
    function setupOAuth() {
        Swal.fire({
            title: 'YouTube OAuth Setup Guide',
            html: `
                <div class="text-start">
                    <h6>Follow these steps:</h6>
                    <ol>
                        <li>Go to <a href="https://console.developers.google.com/" target="_blank">Google Console</a></li>
                        <li>Create a new project or select existing</li>
                        <li>Enable YouTube Data API v3</li>
                        <li>Create credentials (OAuth 2.0 Client ID)</li>
                        <li>Add authorized redirect URIs</li>
                        <li>Copy Client ID and Client Secret</li>
                    </ol>
                    <div class="alert alert-info mt-3">
                        <strong>Redirect URI:</strong> ${window.location.origin}/oauth/youtube/callback
                    </div>
                </div>
            `,
            width: 600,
            confirmButtonText: 'Got it!'
        });
    }
    
    // Temperature slider update
    document.getElementById('geminiTemp').addEventListener('input', function() {
        const value = this.value;
        this.title = `Temperature: ${value}`;
    });
    
    // Initialize tooltips
    const temperatureSlider = document.getElementById('geminiTemp');
    temperatureSlider.title = `Temperature: ${temperatureSlider.value}`;
    

    
    // Function to edit API key
    function editApiKey(inputId) {
        const input = document.getElementById(inputId);
        const editBtn = input.parentElement.querySelector('.btn-outline-primary');
        
        if (input.hasAttribute('readonly')) {
            // Enable editing
            input.removeAttribute('readonly');
            input.value = ''; // Clear for new input
            input.focus();
            input.placeholder = 'Enter new API key';
            editBtn.innerHTML = '<i class="fas fa-save"></i> Save';
            editBtn.onclick = () => saveApiKeyEdit(inputId);
        }
    }
    
    function saveApiKeyEdit(inputId) {
        const input = document.getElementById(inputId);
        const newKey = input.value.trim();
        
        if (!newKey) {
            showToast('Please enter a valid API key', 'warning');
            return;
        }
        
        // Determine service type and save
        let service;
        if (inputId.includes('suno')) {
            service = 'suno';
        } else if (inputId.includes('ideogram')) {
            service = 'ideogram';
        } else {
            service = 'gemini';
        }
        
        // Prepare config data
        let configData = {};
        if (service === 'suno') {
            configData.suno_api_key = newKey;
        } else if (service === 'ideogram') {
            configData.ideogram_api_key = newKey;
            configData.ideogram_rendering_speed = document.getElementById('ideogramRenderingSpeed').value;
            configData.ideogram_style_type = document.getElementById('ideogramStyleType').value;
        } else {
            configData.gemini_api_key = newKey;
            configData.gemini_model = document.getElementById('geminiModel').value;
        }
        
        // Save the configuration
        console.log('ðŸš€ Saving edited API key:', { service, configData });
        
        fetch('/api/config/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify(configData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('API key updated successfully!', 'success');
                
                // Reload page to show updated values
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast(`Error: ${data.error || 'Failed to save API key'}`, 'error');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            showToast('Failed to save API key. Please try again.', 'error');
        });
    }
</script>
{% endblock %}