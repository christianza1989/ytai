{% extends "admin_base.html" %}

{% block title %}üéµ Professional Music Generator - Admin Panel{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Music Generator</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="fas fa-music text-primary me-2"></i>
            Professional Music Generator
            <span class="badge bg-success ms-2">AI Powered</span>
        </h1>
    </div>
</div>

<!-- Main Generation Form -->
<div class="row">
    <div class="col-lg-9 mb-4">
        <div class="card">
            <div class="card-header bg-gradient-primary text-white">
                <i class="fas fa-robot me-2"></i>
                <strong>AI Music Creation Studio</strong>
                <span class="badge bg-light text-dark ms-2">Suno AI Powered</span>
            </div>
            <div class="card-body">
                <form id="musicGenerationForm">
                    
                    <!-- Step 1: Music Type Selection -->
                    <div class="creation-step active" id="step1">
                        <h5 class="mb-4">
                            <span class="step-number">1</span>
                            Music Type & Genre Selection
                        </h5>
                        
                        <!-- Music Type Selection -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label fw-bold">Music Type</label>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card music-type-card" data-type="instrumental">
                                            <div class="card-body text-center p-4">
                                                <i class="fas fa-guitar fa-3x text-info mb-3"></i>
                                                <h6>Instrumental</h6>
                                                <small class="text-muted">Pure music without vocals</small>
                                                <input type="radio" name="music_type" value="instrumental" class="form-check-input mt-3" checked>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card music-type-card" data-type="vocal">
                                            <div class="card-body text-center p-4">
                                                <i class="fas fa-microphone fa-3x text-success mb-3"></i>
                                                <h6>With Vocals</h6>
                                                <small class="text-muted">Music with singing/vocals</small>
                                                <input type="radio" name="music_type" value="vocal" class="form-check-input mt-3">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Genre Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="musicGenreCategory" class="form-label fw-bold">Music Category</label>
                                <select class="form-select" id="musicGenreCategory" name="genre_category" required>
                                    <option value="">Select Category...</option>
                                    <option value="electronic">üéõÔ∏è Electronic Music</option>
                                    <option value="hip_hop">üé§ Hip Hop & Rap</option>
                                    <option value="pop">üéµ Pop Music</option>
                                    <option value="rock">üé∏ Rock & Metal</option>
                                    <option value="jazz_blues">üé∑ Jazz & Blues</option>
                                    <option value="classical">üéº Classical & Orchestral</option>
                                    <option value="world">üåç World Music</option>
                                    <option value="ambient">üåä Ambient & Chill</option>
                                    <option value="dance">üíÉ Dance & Club</option>
                                    <option value="folk_country">ü™ï Folk & Country</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="musicGenreSpecific" class="form-label fw-bold">Specific Genre</label>
                                <select class="form-select" id="musicGenreSpecific" name="genre_specific" required>
                                    <option value="">First select a category...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Mood & Style -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="musicMood" class="form-label fw-bold">Mood/Atmosphere</label>
                                <select class="form-select" id="musicMood" name="mood">
                                    <option value="energetic">‚ö° Energetic</option>
                                    <option value="calm" selected>üòå Calm & Peaceful</option>
                                    <option value="melancholic">üò¢ Melancholic</option>
                                    <option value="happy">üòä Happy & Uplifting</option>
                                    <option value="mysterious">üîÆ Mysterious</option>
                                    <option value="romantic">üíï Romantic</option>
                                    <option value="aggressive">üî• Aggressive</option>
                                    <option value="nostalgic">üìº Nostalgic</option>
                                    <option value="dreamy">‚òÅÔ∏è Dreamy</option>
                                    <option value="dark">üñ§ Dark & Moody</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="musicTempo" class="form-label fw-bold">Tempo</label>
                                <select class="form-select" id="musicTempo" name="tempo">
                                    <option value="slow">üêå Slow (60-80 BPM)</option>
                                    <option value="moderate" selected>üö∂ Moderate (80-120 BPM)</option>
                                    <option value="fast">üèÉ Fast (120-140 BPM)</option>
                                    <option value="very_fast">‚ö° Very Fast (140+ BPM)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Vocal Configuration (Hidden by default) -->
                    <div class="creation-step" id="step2" style="display: none;">
                        <h5 class="mb-4">
                            <span class="step-number">2</span>
                            Vocal Configuration
                        </h5>

                        <!-- Vocal Settings -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="vocalGender" class="form-label fw-bold">Vocal Gender</label>
                                <select class="form-select" id="vocalGender" name="vocal_gender">
                                    <option value="female">üë© Female Voice</option>
                                    <option value="male">üë® Male Voice</option>
                                    <option value="mixed">üë´ Mixed/Duet</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="vocalStyle" class="form-label fw-bold">Vocal Style</label>
                                <select class="form-select" id="vocalStyle" name="vocal_style">
                                    <option value="soft">üéµ Soft & Gentle</option>
                                    <option value="powerful">üí™ Powerful & Strong</option>
                                    <option value="raspy">üé∏ Raspy & Rough</option>
                                    <option value="smooth">üé∑ Smooth & Silky</option>
                                    <option value="emotional">üò¢ Emotional & Expressive</option>
                                    <option value="operatic">üé≠ Operatic & Classical</option>
                                </select>
                            </div>
                        </div>

                        <!-- Language Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="songLanguage" class="form-label fw-bold">Song Language</label>
                                <select class="form-select" id="songLanguage" name="language">
                                    <option value="english">üá∫üá∏ English</option>
                                    <option value="lithuanian">üá±üáπ Lithuanian</option>
                                    <option value="spanish">üá™üá∏ Spanish</option>
                                    <option value="french">üá´üá∑ French</option>
                                    <option value="italian">üáÆüáπ Italian</option>
                                    <option value="german">üá©üá™ German</option>
                                    <option value="japanese">üáØüáµ Japanese</option>
                                    <option value="korean">üá∞üá∑ Korean</option>
                                    <option value="portuguese">üáµüáπ Portuguese</option>
                                    <option value="russian">üá∑üá∫ Russian</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="lyricsMode" class="form-label fw-bold">Lyrics Source</label>
                                <select class="form-select" id="lyricsMode" name="lyrics_mode">
                                    <option value="ai_generated">ü§ñ AI Generated Lyrics</option>
                                    <option value="custom">‚úçÔ∏è Custom Lyrics</option>
                                    <option value="instrumental_vocal">üéµ Vocal Sounds (No Words)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Custom Lyrics Input -->
                        <div id="customLyricsSection" style="display: none;">
                            <div class="mb-4">
                                <label for="customLyrics" class="form-label fw-bold">Custom Lyrics</label>
                                <textarea class="form-control" id="customLyrics" name="custom_lyrics" rows="8" 
                                          placeholder="Enter your song lyrics here...&#10;&#10;[Verse 1]&#10;Your lyrics here...&#10;&#10;[Chorus]&#10;Your chorus lyrics..."></textarea>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Structure your lyrics with [Verse], [Chorus], [Bridge] markers for better results
                                </div>
                            </div>
                        </div>

                        <!-- AI Lyrics Theme -->
                        <div id="aiLyricsSection">
                            <div class="mb-4">
                                <label for="lyricsTheme" class="form-label fw-bold">Lyrics Theme/Topic</label>
                                <input type="text" class="form-control" id="lyricsTheme" name="lyrics_theme" 
                                       placeholder="e.g., lost love, summer adventure, city life, dreams, friendship">
                                <div class="form-text">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Describe what you want the song to be about
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Advanced Settings -->
                    <div class="creation-step" id="step3">
                        <h5 class="mb-4">
                            <span class="step-number">3</span>
                            Advanced Settings & Prompt
                        </h5>

                        <!-- Song Details -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="songTitle" class="form-label fw-bold">Song Title (Optional)</label>
                                <input type="text" class="form-control" id="songTitle" name="song_title" 
                                       placeholder="Leave empty for AI to generate">
                            </div>
                            <div class="col-md-6">
                                <label for="songDuration" class="form-label fw-bold">Duration</label>
                                <select class="form-select" id="songDuration" name="duration">
                                    <option value="short">‚è±Ô∏è Short (30-60s)</option>
                                    <option value="medium" selected>‚è∞ Medium (60-120s)</option>
                                    <option value="long">‚è≥ Long (120-240s)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Custom Prompt -->
                        <div class="mb-4">
                            <label for="customPrompt" class="form-label fw-bold">Custom Music Prompt</label>
                            <textarea class="form-control" id="customPrompt" name="custom_prompt" rows="4" 
                                      placeholder="Describe your desired music in detail...&#10;e.g., 'Upbeat electronic track with heavy bass drops, synthetic leads, and energetic drums perfect for a nightclub'"></textarea>
                            <div class="form-text">
                                <i class="fas fa-magic me-1"></i>
                                This will override the automatic prompt generation. Be as descriptive as possible.
                            </div>
                        </div>

                        <!-- Advanced Options -->
                        <div class="card bg-light">
                            <div class="card-header bg-transparent">
                                <button class="btn btn-link p-0 text-decoration-none fw-bold" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#advancedOptions">
                                    <i class="fas fa-cogs me-2"></i>
                                    Advanced Suno Options
                                    <i class="fas fa-chevron-down ms-2"></i>
                                </button>
                            </div>
                            <div class="collapse" id="advancedOptions">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="makeInstrumental" name="make_instrumental">
                                                <label class="form-check-label" for="makeInstrumental">
                                                    Force Instrumental Mode
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="waitAudio" name="wait_audio" checked>
                                                <label class="form-check-label" for="waitAudio">
                                                    Wait for Audio Generation
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="sunoModel" class="form-label">Suno Model</label>
                                            <select class="form-select form-select-sm" id="sunoModel" name="suno_model">
                                                <option value="chirp-v3-5" selected>Chirp v3.5 (Latest)</option>
                                                <option value="chirp-v3-0">Chirp v3.0</option>
                                                <option value="chirp-v2-xxl-alpha">Chirp v2 XXL</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Generation Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                    <i class="fas fa-undo me-1"></i>
                                    Reset Form
                                </button>
                                <button type="button" class="btn btn-outline-info ms-2" onclick="previewGeneration()">
                                    <i class="fas fa-eye me-1"></i>
                                    Preview Settings
                                </button>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-primary btn-lg" id="generateMusicBtn">
                                    <i class="fas fa-music me-2"></i>
                                    Generate Music
                                </button>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- Right Sidebar - Status & Info -->
    <div class="col-lg-3 mb-4">
        <!-- API Status Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-server me-2"></i>
                API Status
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-music me-2"></i>Suno AI</span>
                        <span class="status-badge status-connected">Connected</span>
                    </div>
                    <small class="text-success">Ready for music generation</small>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-brain me-2"></i>Gemini AI</span>
                        <span class="status-badge status-connected">Connected</span>
                    </div>
                    <small class="text-success">Ready for AI assistance</small>
                </div>
            </div>
        </div>

        <!-- Generation Progress Panel (Hidden by default) -->
        <div class="card mb-4" id="progressPanel" style="display: none;">
            <div class="card-header bg-info text-white">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Generation in Progress
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="generationProgressBar">
                        <span id="progressText">0%</span>
                    </div>
                </div>
                <div class="mb-3">
                    <small class="text-muted" id="currentGenerationStep">Initializing...</small>
                </div>
                <div class="d-grid">
                    <button class="btn btn-outline-danger btn-sm" onclick="cancelGeneration()">
                        <i class="fas fa-stop me-1"></i>
                        Cancel Generation
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Templates -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-templates me-2"></i>
                Quick Templates
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="loadTemplate('lofi_chill')">
                        üéµ Lo-Fi Chill
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadTemplate('electronic_dance')">
                        üíÉ Electronic Dance
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadTemplate('acoustic_folk')">
                        ü™ï Acoustic Folk
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadTemplate('cinematic_epic')">
                        üé¨ Cinematic Epic
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadTemplate('hip_hop_beats')">
                        üé§ Hip Hop Beats
                    </button>
                </div>
            </div>
        </div>

        <!-- Tips & Info -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-lightbulb me-2"></i>
                Pro Tips
            </div>
            <div class="card-body">
                <div class="small">
                    <p class="mb-2">
                        <strong>üí° Better Results:</strong>
                        Be specific in your prompts and themes.
                    </p>
                    <p class="mb-2">
                        <strong>üéµ Vocal Quality:</strong>
                        Choose appropriate vocal style for your genre.
                    </p>
                    <p class="mb-2">
                        <strong>‚è±Ô∏è Generation Time:</strong>
                        Typical generation takes 2-5 minutes.
                    </p>
                    <p class="mb-0">
                        <strong>üîÑ Multiple Versions:</strong>
                        Try different prompts for variety.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Professional Music Generator JavaScript

let currentGenerationTaskId = null;
let generationPollingInterval = null;

// Genre categories mapping
const genreCategories = {
    electronic: [
        'House', 'Techno', 'Trance', 'Dubstep', 'Drum & Bass', 'IDM', 
        'Synthwave', 'Electro', 'Progressive House', 'Deep House',
        'Ambient Techno', 'Breakbeat', 'Garage', 'Future Bass'
    ],
    hip_hop: [
        'Trap', 'Old School Hip Hop', 'Boom Bap', 'Lo-Fi Hip Hop',
        'Gangsta Rap', 'Conscious Hip Hop', 'Mumble Rap', 'Cloud Rap',
        'Jazz Hip Hop', 'Alternative Hip Hop', 'Phonk'
    ],
    pop: [
        'Mainstream Pop', 'Indie Pop', 'Synth Pop', 'Dream Pop',
        'Electropop', 'Art Pop', 'Power Pop', 'Bubblegum Pop',
        'K-Pop', 'J-Pop', 'Dance Pop', 'Teen Pop'
    ],
    rock: [
        'Classic Rock', 'Hard Rock', 'Punk Rock', 'Alternative Rock',
        'Indie Rock', 'Progressive Rock', 'Heavy Metal', 'Death Metal',
        'Black Metal', 'Post Rock', 'Grunge', 'Psychedelic Rock'
    ],
    jazz_blues: [
        'Smooth Jazz', 'Bebop', 'Cool Jazz', 'Fusion', 'Free Jazz',
        'Blues', 'Chicago Blues', 'Delta Blues', 'Electric Blues',
        'Swing', 'Big Band', 'Acid Jazz'
    ],
    classical: [
        'Baroque', 'Classical', 'Romantic', 'Modern Classical',
        'Minimalist', 'Orchestral', 'Chamber Music', 'Opera',
        'Symphony', 'Concerto', 'Neoclassical', 'Film Score'
    ],
    world: [
        'Celtic', 'Flamenco', 'Bossa Nova', 'Reggae', 'Afrobeat',
        'Indian Classical', 'Arabic', 'Latin', 'Salsa', 'Tango',
        'Balkan', 'Middle Eastern', 'African Traditional'
    ],
    ambient: [
        'Dark Ambient', 'Space Ambient', 'Drone', 'New Age',
        'Meditation', 'Nature Sounds', 'Cinematic Ambient',
        'Minimal Ambient', 'Experimental', 'Sound Healing'
    ],
    dance: [
        'Club Dance', 'Euro Dance', 'Hardcore', 'Gabber',
        'Happy Hardcore', 'UK Garage', 'Jersey Club',
        'Ballroom', 'Vogue', 'Commercial Dance'
    ],
    folk_country: [
        'Traditional Folk', 'Indie Folk', 'Country', 'Bluegrass',
        'Americana', 'Alt-Country', 'Folk Rock', 'Celtic Folk',
        'Singer-Songwriter', 'Acoustic', 'Campfire Songs'
    ]
};

// Initialize form interactions
document.addEventListener('DOMContentLoaded', function() {
    initializeMusicTypeSelection();
    initializeGenreSelection();
    initializeVocalSettings();
    initializeLyricsMode();
    updateFormVisibility();
});

// Music type selection
function initializeMusicTypeSelection() {
    const typeCards = document.querySelectorAll('.music-type-card');
    typeCards.forEach(card => {
        card.addEventListener('click', function() {
            const type = this.dataset.type;
            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;
            updateMusicTypeSelection();
            updateFormVisibility();
        });
    });
    
    // Initialize on page load
    updateMusicTypeSelection();
}

function updateMusicTypeSelection() {
    const typeCards = document.querySelectorAll('.music-type-card');
    typeCards.forEach(card => {
        const radio = card.querySelector('input[type="radio"]');
        if (radio.checked) {
            card.classList.add('border-primary', 'bg-light');
            card.style.transform = 'scale(1.05)';
        } else {
            card.classList.remove('border-primary', 'bg-light');
            card.style.transform = 'scale(1)';
        }
    });
}

// Genre selection system
function initializeGenreSelection() {
    const categorySelect = document.getElementById('musicGenreCategory');
    const specificSelect = document.getElementById('musicGenreSpecific');
    
    categorySelect.addEventListener('change', function() {
        const category = this.value;
        updateSpecificGenres(category);
    });
}

function updateSpecificGenres(category) {
    const specificSelect = document.getElementById('musicGenreSpecific');
    specificSelect.innerHTML = '<option value="">Select specific genre...</option>';
    
    if (category && genreCategories[category]) {
        genreCategories[category].forEach(genre => {
            const option = document.createElement('option');
            option.value = genre.toLowerCase().replace(/[^a-z0-9]/g, '_');
            option.textContent = genre;
            specificSelect.appendChild(option);
        });
        specificSelect.disabled = false;
    } else {
        specificSelect.disabled = true;
    }
}

// Vocal settings
function initializeVocalSettings() {
    const vocalGenderSelect = document.getElementById('vocalGender');
    const vocalStyleSelect = document.getElementById('vocalStyle');
    
    vocalGenderSelect.addEventListener('change', updateVocalStyles);
    updateVocalStyles(); // Initialize
}

function updateVocalStyles() {
    const gender = document.getElementById('vocalGender').value;
    const styleSelect = document.getElementById('vocalStyle');
    
    // Clear current options
    styleSelect.innerHTML = '';
    
    if (gender === 'female') {
        const femaleStyles = [
            { value: 'soft_female', text: 'üéµ Soft & Gentle' },
            { value: 'powerful_female', text: 'üí™ Powerful & Strong' },
            { value: 'sweet_female', text: 'üçØ Sweet & Melodic' },
            { value: 'breathy_female', text: 'üòò Breathy & Sensual' },
            { value: 'operatic_female', text: 'üé≠ Operatic & Classical' },
            { value: 'indie_female', text: 'üåü Indie & Alternative' }
        ];
        femaleStyles.forEach(style => {
            const option = document.createElement('option');
            option.value = style.value;
            option.textContent = style.text;
            styleSelect.appendChild(option);
        });
    } else if (gender === 'male') {
        const maleStyles = [
            { value: 'smooth_male', text: 'üé∑ Smooth & Silky' },
            { value: 'powerful_male', text: 'üí™ Powerful & Strong' },
            { value: 'raspy_male', text: 'üé∏ Raspy & Rough' },
            { value: 'deep_male', text: 'üé§ Deep & Rich' },
            { value: 'emotional_male', text: 'üò¢ Emotional & Expressive' },
            { value: 'rapper_male', text: 'üé§ Rap/Hip-Hop Style' }
        ];
        maleStyles.forEach(style => {
            const option = document.createElement('option');
            option.value = style.value;
            option.textContent = style.text;
            styleSelect.appendChild(option);
        });
    } else if (gender === 'mixed') {
        const mixedStyles = [
            { value: 'harmony_mixed', text: 'üéµ Harmony Duet' },
            { value: 'call_response', text: 'üé§ Call & Response' },
            { value: 'alternating_mixed', text: 'üîÑ Alternating Vocals' },
            { value: 'choir_mixed', text: 'üë• Choir/Group' }
        ];
        mixedStyles.forEach(style => {
            const option = document.createElement('option');
            option.value = style.value;
            option.textContent = style.text;
            styleSelect.appendChild(option);
        });
    }
}

// Lyrics mode handling
function initializeLyricsMode() {
    const lyricsMode = document.getElementById('lyricsMode');
    lyricsMode.addEventListener('change', updateLyricsSection);
    updateLyricsSection(); // Initialize
}

function updateLyricsSection() {
    const mode = document.getElementById('lyricsMode').value;
    const customSection = document.getElementById('customLyricsSection');
    const aiSection = document.getElementById('aiLyricsSection');
    
    if (mode === 'custom') {
        customSection.style.display = 'block';
        aiSection.style.display = 'none';
    } else if (mode === 'ai_generated') {
        customSection.style.display = 'none';
        aiSection.style.display = 'block';
    } else {
        customSection.style.display = 'none';
        aiSection.style.display = 'none';
    }
}

// Form visibility based on music type
function updateFormVisibility() {
    const musicType = document.querySelector('input[name="music_type"]:checked').value;
    const step2 = document.getElementById('step2');
    
    if (musicType === 'vocal') {
        step2.style.display = 'block';
        step2.classList.add('active');
    } else {
        step2.style.display = 'none';
        step2.classList.remove('active');
    }
}

// Form submission
document.getElementById('musicGenerationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    startMusicGeneration();
});

function startMusicGeneration() {
    const formData = new FormData(document.getElementById('musicGenerationForm'));
    const data = Object.fromEntries(formData);
    
    // Add checkboxes
    data.make_instrumental = document.getElementById('makeInstrumental').checked;
    data.wait_audio = document.getElementById('waitAudio').checked;
    
    // Build the generation prompt
    data.generated_prompt = buildGenerationPrompt(data);
    
    // Show confirmation dialog
    Swal.fire({
        title: 'Generate Music?',
        html: `
            <div class="text-start">
                <p><strong>Type:</strong> ${data.music_type}</p>
                <p><strong>Genre:</strong> ${document.getElementById('musicGenreSpecific').selectedOptions[0]?.text || 'Auto'}</p>
                <p><strong>Mood:</strong> ${document.getElementById('musicMood').selectedOptions[0]?.text || 'Auto'}</p>
                ${data.music_type === 'vocal' ? `<p><strong>Language:</strong> ${document.getElementById('songLanguage').selectedOptions[0]?.text || 'Auto'}</p>` : ''}
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Generate Music!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            executeMusicGeneration(data);
        }
    });
}

function buildGenerationPrompt(data) {
    let prompt = '';
    
    // Add genre and mood
    if (data.genre_specific) {
        const genreText = document.getElementById('musicGenreSpecific').selectedOptions[0]?.text;
        prompt += `${genreText} music, `;
    }
    
    const moodText = document.getElementById('musicMood').selectedOptions[0]?.text.split(' ')[1] || data.mood;
    prompt += `${moodText} mood, `;
    
    // Add tempo
    const tempoText = document.getElementById('musicTempo').selectedOptions[0]?.text.split(' ')[1] || data.tempo;
    prompt += `${tempoText} tempo`;
    
    // Add vocal information if applicable
    if (data.music_type === 'vocal') {
        const genderText = document.getElementById('vocalGender').selectedOptions[0]?.text;
        const styleText = document.getElementById('vocalStyle').selectedOptions[0]?.text.split(' ')[1] || data.vocal_style;
        prompt += `, ${genderText.toLowerCase()} vocals, ${styleText} style`;
    }
    
    // Use custom prompt if provided
    if (data.custom_prompt && data.custom_prompt.trim()) {
        return data.custom_prompt.trim();
    }
    
    return prompt;
}

function executeMusicGeneration(data) {
    // Show progress panel
    document.getElementById('progressPanel').style.display = 'block';
    document.getElementById('generateMusicBtn').disabled = true;
    document.getElementById('generateMusicBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    
    // Start generation
    fetch('/api/music/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            currentGenerationTaskId = result.task_id;
            startProgressTracking();
        } else {
            showGenerationError('Failed to start generation: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(error => {
        showGenerationError('Network error: ' + error.message);
    });
}

function startProgressTracking() {
    generationPollingInterval = setInterval(() => {
        if (currentGenerationTaskId) {
            fetch(`/api/music/status/${currentGenerationTaskId}`)
                .then(response => response.json())
                .then(task => {
                    updateGenerationProgress(task);
                    
                    if (task.status === 'completed' || task.status === 'failed') {
                        clearInterval(generationPollingInterval);
                        handleGenerationComplete(task);
                    }
                })
                .catch(error => {
                    console.error('Progress tracking error:', error);
                });
        }
    }, 2000);
}

function updateGenerationProgress(task) {
    const progressBar = document.getElementById('generationProgressBar');
    const progressText = document.getElementById('progressText');
    const currentStep = document.getElementById('currentGenerationStep');
    
    progressBar.style.width = (task.progress || 0) + '%';
    progressText.textContent = (task.progress || 0) + '%';
    currentStep.textContent = task.current_step || 'Processing...';
}

function handleGenerationComplete(task) {
    // Reset UI
    resetGenerationUI();
    
    if (task.status === 'completed' && task.result) {
        Swal.fire({
            title: 'Music Generated Successfully!',
            html: `
                <div class="text-start">
                    <p><strong>Title:</strong> ${task.result.title || 'Generated Music'}</p>
                    <p><strong>Duration:</strong> ${task.result.duration || 'Unknown'}</p>
                    <p><strong>Audio URL:</strong> <a href="${task.result.audio_url}" target="_blank">Listen</a></p>
                    ${task.result.video_url ? `<p><strong>Video URL:</strong> <a href="${task.result.video_url}" target="_blank">Watch</a></p>` : ''}
                </div>
            `,
            icon: 'success',
            confirmButtonText: 'View Projects',
            showCancelButton: true,
            cancelButtonText: 'Create Another'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '{{ url_for("projects") }}';
            }
        });
    } else {
        Swal.fire({
            title: 'Generation Failed',
            text: task.result?.error || 'Unknown error occurred',
            icon: 'error'
        });
    }
    
    currentGenerationTaskId = null;
}

function cancelGeneration() {
    if (currentGenerationTaskId && generationPollingInterval) {
        clearInterval(generationPollingInterval);
        
        // Attempt to cancel on server
        fetch(`/api/music/cancel/${currentGenerationTaskId}`, {
            method: 'POST'
        }).catch(console.error);
        
        resetGenerationUI();
        showToast('Generation cancelled', 'info');
    }
}

function resetGenerationUI() {
    document.getElementById('progressPanel').style.display = 'none';
    document.getElementById('generateMusicBtn').disabled = false;
    document.getElementById('generateMusicBtn').innerHTML = '<i class="fas fa-music me-2"></i>Generate Music';
}

function showGenerationError(message) {
    resetGenerationUI();
    Swal.fire({
        title: 'Generation Error',
        text: message,
        icon: 'error'
    });
}

// Template loading
function loadTemplate(templateName) {
    const templates = {
        lofi_chill: {
            music_type: 'instrumental',
            genre_category: 'hip_hop',
            genre_specific: 'lo_fi_hip_hop',
            mood: 'calm',
            tempo: 'slow',
            custom_prompt: 'Relaxing lo-fi hip hop with soft piano, vinyl crackle, muted drums, and atmospheric pads'
        },
        electronic_dance: {
            music_type: 'instrumental',
            genre_category: 'electronic',
            genre_specific: 'house',
            mood: 'energetic',
            tempo: 'fast',
            custom_prompt: 'Upbeat house music with four-on-the-floor kick, synthesizer leads, and building energy'
        },
        acoustic_folk: {
            music_type: 'vocal',
            genre_category: 'folk_country',
            genre_specific: 'indie_folk',
            mood: 'nostalgic',
            tempo: 'moderate',
            vocal_gender: 'female',
            vocal_style: 'soft_female',
            language: 'english',
            lyrics_mode: 'ai_generated',
            lyrics_theme: 'memories and home'
        },
        cinematic_epic: {
            music_type: 'instrumental',
            genre_category: 'classical',
            genre_specific: 'film_score',
            mood: 'mysterious',
            tempo: 'moderate',
            custom_prompt: 'Epic cinematic orchestral piece with rising strings, powerful brass, and dramatic percussion'
        },
        hip_hop_beats: {
            music_type: 'instrumental',
            genre_category: 'hip_hop',
            genre_specific: 'trap',
            mood: 'aggressive',
            tempo: 'fast',
            custom_prompt: 'Hard-hitting trap beats with 808 drums, hi-hats, and dark atmospheric sounds'
        }
    };
    
    const template = templates[templateName];
    if (template) {
        // Set form values
        Object.keys(template).forEach(key => {
            const element = document.getElementById(key) || 
                           document.querySelector(`input[name="${key}"]`) ||
                           document.querySelector(`select[name="${key}"]`) ||
                           document.querySelector(`textarea[name="${key}"]`);
            
            if (element) {
                if (element.type === 'radio') {
                    document.querySelector(`input[name="${key}"][value="${template[key]}"]`).checked = true;
                } else {
                    element.value = template[key];
                }
            }
        });
        
        // Update dependent fields
        if (template.genre_category) {
            updateSpecificGenres(template.genre_category);
            setTimeout(() => {
                if (template.genre_specific) {
                    document.getElementById('musicGenreSpecific').value = template.genre_specific;
                }
            }, 100);
        }
        
        // Update form visibility
        updateFormVisibility();
        updateMusicTypeSelection();
        if (template.vocal_gender) {
            updateVocalStyles();
            setTimeout(() => {
                if (template.vocal_style) {
                    document.getElementById('vocalStyle').value = template.vocal_style;
                }
            }, 100);
        }
        if (template.lyrics_mode) {
            updateLyricsSection();
        }
        
        showToast(`Template "${templateName.replace('_', ' ')}" loaded!`, 'success');
    }
}

// Utility functions
function resetForm() {
    document.getElementById('musicGenerationForm').reset();
    
    // Reset to defaults
    document.querySelector('input[name="music_type"][value="instrumental"]').checked = true;
    document.getElementById('musicMood').value = 'calm';
    document.getElementById('musicTempo').value = 'moderate';
    document.getElementById('songDuration').value = 'medium';
    document.getElementById('sunoModel').value = 'chirp-v3-5';
    document.getElementById('waitAudio').checked = true;
    
    updateFormVisibility();
    updateMusicTypeSelection();
    
    showToast('Form reset to defaults', 'info');
}

function previewGeneration() {
    const formData = new FormData(document.getElementById('musicGenerationForm'));
    const data = Object.fromEntries(formData);
    
    const musicType = data.music_type;
    const genreCategory = document.getElementById('musicGenreCategory').selectedOptions[0]?.text || 'Auto';
    const genreSpecific = document.getElementById('musicGenreSpecific').selectedOptions[0]?.text || 'Auto';
    const mood = document.getElementById('musicMood').selectedOptions[0]?.text || 'Auto';
    const tempo = document.getElementById('musicTempo').selectedOptions[0]?.text || 'Auto';
    
    let previewHtml = `
        <div class="text-start">
            <p><strong>Music Type:</strong> ${musicType}</p>
            <p><strong>Category:</strong> ${genreCategory}</p>
            <p><strong>Genre:</strong> ${genreSpecific}</p>
            <p><strong>Mood:</strong> ${mood}</p>
            <p><strong>Tempo:</strong> ${tempo}</p>
    `;
    
    if (musicType === 'vocal') {
        const gender = document.getElementById('vocalGender').selectedOptions[0]?.text || 'Auto';
        const style = document.getElementById('vocalStyle').selectedOptions[0]?.text || 'Auto';
        const language = document.getElementById('songLanguage').selectedOptions[0]?.text || 'Auto';
        previewHtml += `
            <p><strong>Vocal Gender:</strong> ${gender}</p>
            <p><strong>Vocal Style:</strong> ${style}</p>
            <p><strong>Language:</strong> ${language}</p>
        `;
    }
    
    previewHtml += `
            <p><strong>Generated Prompt:</strong></p>
            <div class="bg-light p-2 rounded small">${buildGenerationPrompt(data)}</div>
        </div>
    `;
    
    Swal.fire({
        title: 'Generation Preview',
        html: previewHtml,
        icon: 'info',
        width: 600
    });
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    // All initialization functions are called above
    console.log('Professional Music Generator initialized');
});

</script>
{% endblock %}