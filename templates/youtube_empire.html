{% extends "admin_base.html" %}

{% block title %}YouTube Empire Manager - Pelno Generatorius{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">YouTube Empire</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="fab fa-youtube text-danger me-2"></i>
            YouTube Empire Manager
            <span class="badge bg-success ms-2">PROFIT MAXIMIZER</span>
        </h1>
    </div>
</div>

<!-- Empire Overview Cards -->
<div class="row mb-4" id="empireOverview">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0" id="totalChannels">-</div>
                        <div class="small">Active Channels</div>
                    </div>
                    <i class="fab fa-youtube fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0" id="monthlyVideos">-</div>
                        <div class="small">Monthly Videos</div>
                    </div>
                    <i class="fas fa-video fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0" id="monthlyViews">-</div>
                        <div class="small">Est. Monthly Views</div>
                    </div>
                    <i class="fas fa-eye fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0" id="monthlyRevenue">-</div>
                        <div class="small">Monthly Revenue</div>
                    </div>
                    <i class="fas fa-dollar-sign fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mass Generation Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-gradient-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-rocket me-2"></i>
                    Masinis Content Generavimas
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="text-success">ðŸŽ¯ Strategija: Maximum Output = Maximum Profit</h6>
                        <p class="text-muted">
                            Generuokite deÅ¡imtis video vienu metu visiems kanalams. 
                            AutomatiÅ¡kai optimizuoti SEO, metadata ir upload schedule.
                        </p>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Video Kiekis</label>
                                <select class="form-select" id="batchSize">
                                    <option value="10">10 video (Test)</option>
                                    <option value="20" selected>20 video (Daily)</option>
                                    <option value="50">50 video (Weekly)</option>
                                    <option value="100">100 video (Monthly)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Prioritetas</label>
                                <select class="form-select" id="priority">
                                    <option value="balanced" selected>Balanced (visi stiliai)</option>
                                    <option value="trending">Trending (populiarÅ«s)</option>
                                    <option value="profit">High Profit (RPM focus)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Upload Strategy</label>
                                <select class="form-select" id="uploadStrategy">
                                    <option value="optimal" selected>Optimal Time</option>
                                    <option value="spread">Spread Out</option>
                                    <option value="burst">Burst Upload</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="mb-3">
                            <div class="h2 text-success" id="estimatedProfit">$0</div>
                            <small class="text-muted">Estimated Monthly Profit</small>
                        </div>
                        <button class="btn btn-success btn-lg w-100" id="startMassGeneration">
                            <i class="fas fa-rocket me-2"></i>
                            Start Mass Generation
                        </button>
                    </div>
                </div>
                
                <!-- Mass Generation Progress -->
                <div class="mt-4 d-none" id="massGenerationProgress">
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-info me-3" role="status"></div>
                            <div class="flex-grow-1">
                                <div class="fw-bold" id="massGenStep">Pradedamas masinis generavimas...</div>
                                <div class="progress mt-2" style="height: 20px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         id="massGenProgressBar" role="progressbar" style="width: 0%">
                                        <span id="massGenPercent">0%</span>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small id="massGenLogs" class="text-muted"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Channels Management -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-tv me-2"></i>
                        KanalÅ³ Valdymas
                    </h5>
                    <button class="btn btn-primary btn-sm" onclick="loadChannels()">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="channelsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Channel Name</th>
                                <th>Style</th>
                                <th>Upload Schedule</th>
                                <th>Performance</th>
                                <th>Est. Monthly Revenue</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="channelsTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading channels...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Smart Thumbnail Generator -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-gradient text-white" style="background: linear-gradient(45deg, #FF6B6B, #FFE66D);">
                <h5 class="mb-0">
                    <i class="fas fa-image me-2"></i>
                    ðŸŽ¨ Smart Thumbnail Generator - CTR Maximizer
                    <span class="badge bg-success ms-2">NEW!</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-warning">ðŸŽ¯ AI-Powered Thumbnail Optimization</h6>
                        <p class="text-muted mb-3">
                            Generuoja CTR-optimizuotus thumbnail'us su A/B testing. AutomatiÅ¡kai padidina paspaudimai 150-300%!
                        </p>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Style</label>
                                <select class="form-select" id="thumbStyle">
                                    <option value="lofi">Lo-Fi (Cozy Aesthetic)</option>
                                    <option value="gaming">Gaming (Epic Action)</option>
                                    <option value="meditation">Meditation (Peaceful)</option>
                                    <option value="trap">Trap (Bold Urban)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Variants</label>
                                <select class="form-select" id="thumbVariants">
                                    <option value="3">3 Variants (A/B/C Test)</option>
                                    <option value="5">5 Variants (Extended Test)</option>
                                    <option value="1">1 Optimized (Quick)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Video Title</label>
                            <input type="text" class="form-control" id="thumbTitle" 
                                   placeholder="Enter video title for thumbnail optimization">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-warning w-100" id="generateSingleThumb">
                                    <i class="fas fa-magic me-2"></i>
                                    Generate Thumbnail
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-success w-100" id="batchGenerateThumbs">
                                    <i class="fas fa-images me-2"></i>
                                    Batch Generate (5x)
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card bg-light border-warning">
                            <div class="card-body">
                                <h6 class="text-warning">ðŸ’¡ Thumbnail ROI Benefits:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-chart-up text-success me-2"></i>150-300% CTR increase</li>
                                    <li><i class="fas fa-eye text-info me-2"></i>Smart A/B testing variants</li>
                                    <li><i class="fas fa-palette text-warning me-2"></i>Style-specific optimization</li>
                                    <li><i class="fas fa-mobile-alt text-primary me-2"></i>Mobile-optimized design</li>
                                    <li><i class="fas fa-dollar-sign text-success me-2"></i>Immediate revenue boost</li>
                                </ul>
                                
                                <div class="mt-3 text-center">
                                    <div class="h4 text-success" id="thumbEstimatedROI">+$666</div>
                                    <small class="text-muted">Monthly Revenue Boost</small>
                                </div>
                                
                                <div class="mt-2 text-center">
                                    <small class="badge bg-success">ROI Timeline: 1-2 days</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Thumbnail Results -->
                <div class="mt-4 d-none" id="thumbResults">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-images me-2"></i>Generated Thumbnails</h6>
                        <div id="thumbResultsContent">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SEO Optimization Tools -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>
                    AI SEO Optimizer - Maximum Discoverability
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">ðŸŽ¯ Trending Keywords & Optimization</h6>
                        <p class="text-muted mb-3">
                            AI analizuoja trending keyword'us, optimizuoja metadata ir maksimizuoja views potencialÄ….
                        </p>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Style</label>
                                <select class="form-select" id="seoStyle">
                                    <option value="lofi">Lo-Fi (High RPM)</option>
                                    <option value="gaming">Gaming (Massive Audience)</option>
                                    <option value="meditation">Meditation (Premium RPM)</option>
                                    <option value="trap">Trap (Trending)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mood</label>
                                <select class="form-select" id="seoMood">
                                    <option value="chill">Chill & Relaxed</option>
                                    <option value="epic">Epic & Powerful</option>
                                    <option value="dark">Dark & Intense</option>
                                    <option value="peaceful">Peaceful & Calm</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Custom Title (Optional)</label>
                            <input type="text" class="form-control" id="seoCustomTitle" 
                                   placeholder="Leave empty for AI-generated title">
                        </div>
                        
                        <button class="btn btn-primary me-2" id="optimizeSingle">
                            <i class="fas fa-magic me-2"></i>
                            Optimize Single Video
                        </button>
                        
                        <button class="btn btn-success" id="optimizeBatch">
                            <i class="fas fa-rocket me-2"></i>
                            Batch SEO Optimize (10x)
                        </button>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="text-success">ðŸ’¡ SEO Optimization Benefits:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i>50-300% more views</li>
                                    <li><i class="fas fa-check text-success me-2"></i>AI-powered trending keywords</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Optimal upload timing</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Engagement-focused descriptions</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Revenue maximization</li>
                                </ul>
                                
                                <div class="mt-3 text-center">
                                    <div class="h4 text-success" id="seoEstimatedViews">-</div>
                                    <small class="text-muted">Estimated Views Boost</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SEO Results -->
                <div class="mt-4 d-none" id="seoResults">
                    <div class="alert alert-success">
                        <h6><i class="fas fa-chart-line me-2"></i>SEO Optimization Results</h6>
                        <div id="seoResultsContent">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Automation Tools -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Upload Scheduler
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">AutomatiÅ¡kai suplanuoja Ä¯kÄ—limus optimaliu laiku kiekvienam kanalui.</p>
                
                <div class="mb-3">
                    <label class="form-label">Video Kiekis</label>
                    <input type="number" class="form-control" id="scheduleVideoCount" value="10" min="1" max="50">
                </div>
                
                <button class="btn btn-info w-100" id="scheduleUploads">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Schedule Uploads
                </button>
                
                <div class="mt-3 d-none" id="scheduleResult">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="scheduleResultText">Uploads scheduled successfully!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-comments me-2"></i>
                    Engagement Bot
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Automatiniai komentarai ir engagement veikloms padidinti algoritmÄ….</p>
                
                <div class="mb-3">
                    <label class="form-label">Target Videos</label>
                    <input type="number" class="form-control" id="engagementVideoCount" value="5" min="1" max="20">
                </div>
                
                <button class="btn btn-warning w-100" id="activateEngagement">
                    <i class="fas fa-robot me-2"></i>
                    Activate Engagement Bot
                </button>
                
                <div class="mt-3 d-none" id="engagementResult">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="engagementResultText">Engagement bot activated!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profit Analytics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Profit Analytics & Projections
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="revenueChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="channelPerformanceChart" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <!-- Detailed Breakdown -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6>Channel Performance Breakdown</h6>
                        <div id="channelBreakdown" class="table-responsive">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading analytics...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// YouTube Empire Management JavaScript
let empireData = null;
let massGenerationTaskId = null;
let massGenerationInterval = null;

// Load empire data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadEmpireReport();
    loadChannels();
    
    // Event listeners
    document.getElementById('startMassGeneration').addEventListener('click', startMassGeneration);
    document.getElementById('scheduleUploads').addEventListener('click', scheduleUploads);
    document.getElementById('activateEngagement').addEventListener('click', activateEngagement);
    document.getElementById('optimizeSingle').addEventListener('click', optimizeSingleSEO);
    document.getElementById('optimizeBatch').addEventListener('click', optimizeBatchSEO);
    document.getElementById('generateSingleThumb').addEventListener('click', generateSingleThumbnail);
    document.getElementById('batchGenerateThumbs').addEventListener('click', batchGenerateThumbnails);
    
    // Update profit estimation when batch size changes
    document.getElementById('batchSize').addEventListener('change', updateProfitEstimation);
});

async function loadEmpireReport() {
    try {
        const response = await fetch('/api/youtube/empire-report');
        const data = await response.json();
        empireData = data;
        
        updateEmpireOverview(data);
        updateProfitEstimation();
        createCharts(data);
        
    } catch (error) {
        console.error('Error loading empire report:', error);
    }
}

function updateEmpireOverview(data) {
    const overview = data.empire_overview;
    
    document.getElementById('totalChannels').textContent = overview.total_channels;
    document.getElementById('monthlyVideos').textContent = overview.total_monthly_videos;
    document.getElementById('monthlyViews').textContent = overview.total_estimated_monthly_views.toLocaleString();
    document.getElementById('monthlyRevenue').textContent = '$' + overview.total_estimated_monthly_revenue.toFixed(2);
}

function updateProfitEstimation() {
    if (!empireData) return;
    
    const batchSize = parseInt(document.getElementById('batchSize').value);
    const monthlyRevenue = empireData.empire_overview.total_estimated_monthly_revenue;
    
    // Estimate additional revenue from batch generation
    const additionalRevenue = (batchSize / 30) * monthlyRevenue * 0.3; // 30% boost estimate
    const totalEstimated = monthlyRevenue + additionalRevenue;
    
    document.getElementById('estimatedProfit').textContent = '$' + totalEstimated.toFixed(2);
}

async function loadChannels() {
    try {
        const response = await fetch('/api/youtube/channels');
        const data = await response.json();
        
        const tbody = document.getElementById('channelsTableBody');
        tbody.innerHTML = '';
        
        data.channels.forEach(channel => {
            const performanceColor = channel.performance_score > 0.7 ? 'success' : 
                                   channel.performance_score > 0.4 ? 'warning' : 'danger';
            
            const estimatedRevenue = calculateChannelRevenue(channel);
            
            const row = `
                <tr>
                    <td>
                        <strong>${channel.name}</strong>
                        <br><small class="text-muted">${channel.id}</small>
                    </td>
                    <td>
                        <span class="badge bg-primary">${channel.style}</span>
                    </td>
                    <td>${channel.upload_schedule}</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-${performanceColor}" 
                                 style="width: ${channel.performance_score * 100}%">
                                ${(channel.performance_score * 100).toFixed(0)}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong class="text-success">$${estimatedRevenue.toFixed(2)}</strong>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editChannel('${channel.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="generateForChannel('${channel.id}')">
                            <i class="fas fa-play"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        });
        
    } catch (error) {
        console.error('Error loading channels:', error);
    }
}

function calculateChannelRevenue(channel) {
    const scheduleMultiplier = {
        'daily': 30,
        '3x_week': 12,
        'weekly': 4
    };
    
    const styleRPM = {
        'lofi': 2.5,
        'trap': 1.8,
        'meditation': 3.2,
        'gaming': 2.0
    };
    
    const videos = scheduleMultiplier[channel.upload_schedule] || 4;
    const avgViews = channel.performance_score * 10000; // Simplified calculation
    const rpm = styleRPM[channel.style] || 2.0;
    
    return (videos * avgViews / 1000) * rpm;
}

async function startMassGeneration() {
    const btn = document.getElementById('startMassGeneration');
    const batchSize = document.getElementById('batchSize').value;
    const priority = document.getElementById('priority').value;
    const uploadStrategy = document.getElementById('uploadStrategy').value;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';
    
    try {
        const response = await fetch('/api/youtube/batch-generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                batch_size: parseInt(batchSize),
                priority: priority,
                upload_strategy: uploadStrategy
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            massGenerationTaskId = data.task_id;
            showMassGenerationProgress();
            startMassGenerationPolling();
        } else {
            throw new Error(data.message || 'Failed to start generation');
        }
        
    } catch (error) {
        Swal.fire('Error', 'Failed to start mass generation: ' + error.message, 'error');
        resetMassGenerationButton();
    }
}

function showMassGenerationProgress() {
    document.getElementById('massGenerationProgress').classList.remove('d-none');
}

function startMassGenerationPolling() {
    if (massGenerationInterval) clearInterval(massGenerationInterval);
    
    massGenerationInterval = setInterval(async () => {
        if (!massGenerationTaskId) return;
        
        try {
            const response = await fetch(`/api/generate/status/${massGenerationTaskId}`);
            const data = await response.json();
            
            updateMassGenerationProgress(data);
            
            if (data.status === 'completed' || data.status === 'failed') {
                clearInterval(massGenerationInterval);
                handleMassGenerationCompletion(data);
            }
        } catch (error) {
            console.error('Mass generation polling error:', error);
        }
    }, 2000);
}

function updateMassGenerationProgress(task) {
    document.getElementById('massGenStep').textContent = task.current_step || 'Processing...';
    document.getElementById('massGenProgressBar').style.width = task.progress + '%';
    document.getElementById('massGenPercent').textContent = task.progress + '%';
    
    if (task.logs && task.logs.length > 0) {
        document.getElementById('massGenLogs').innerHTML = task.logs.slice(-3).join('<br>');
    }
}

function handleMassGenerationCompletion(task) {
    if (task.status === 'completed' && task.result && task.result.success) {
        const result = task.result;
        
        Swal.fire({
            title: 'Mass Generation Complete!',
            html: `
                <div class="text-start">
                    <p><strong>Videos Generated:</strong> ${result.videos_generated}</p>
                    <p><strong>Estimated Monthly Revenue:</strong> $${result.estimated_monthly_revenue}</p>
                    <p><strong>Annual Projection:</strong> $${result.annual_projection}</p>
                </div>
            `,
            icon: 'success',
            confirmButtonText: 'View Projects'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/projects';
            }
        });
        
        // Refresh data
        loadEmpireReport();
        
    } else {
        Swal.fire('Error', 'Mass generation failed: ' + (task.result?.error || 'Unknown error'), 'error');
    }
    
    resetMassGenerationButton();
}

function resetMassGenerationButton() {
    const btn = document.getElementById('startMassGeneration');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-rocket me-2"></i>Start Mass Generation';
    massGenerationTaskId = null;
}

async function scheduleUploads() {
    const btn = document.getElementById('scheduleUploads');
    const videoCount = document.getElementById('scheduleVideoCount').value;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Scheduling...';
    
    try {
        const response = await fetch('/api/youtube/upload-schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ video_count: parseInt(videoCount) })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('scheduleResult').classList.remove('d-none');
            document.getElementById('scheduleResultText').textContent = 
                `${data.scheduled_count} uploads scheduled successfully!`;
        }
        
    } catch (error) {
        Swal.fire('Error', 'Failed to schedule uploads: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-calendar-alt me-2"></i>Schedule Uploads';
    }
}

async function activateEngagement() {
    const btn = document.getElementById('activateEngagement');
    const videoCount = document.getElementById('engagementVideoCount').value;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Activating...';
    
    try {
        const response = await fetch('/api/youtube/engagement-bot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ video_count: parseInt(videoCount) })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('engagementResult').classList.remove('d-none');
            document.getElementById('engagementResultText').textContent = 
                `${data.comments_scheduled} comments scheduled for ${data.engagement_actions} actions!`;
        }
        
    } catch (error) {
        Swal.fire('Error', 'Failed to activate engagement bot: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-robot me-2"></i>Activate Engagement Bot';
    }
}

function createCharts(data) {
    // Revenue projection chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Monthly Revenue ($)',
                data: [
                    data.empire_overview.total_estimated_monthly_revenue * 0.3,
                    data.empire_overview.total_estimated_monthly_revenue * 0.5,
                    data.empire_overview.total_estimated_monthly_revenue * 0.7,
                    data.empire_overview.total_estimated_monthly_revenue * 0.9,
                    data.empire_overview.total_estimated_monthly_revenue,
                    data.empire_overview.total_estimated_monthly_revenue * 1.2
                ],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Revenue Growth Projection'
                }
            }
        }
    });
    
    // Channel performance chart
    const performanceCtx = document.getElementById('channelPerformanceChart').getContext('2d');
    const channelNames = Object.keys(data.channel_breakdown);
    const revenues = channelNames.map(name => data.channel_breakdown[name].estimated_monthly_revenue);
    
    new Chart(performanceCtx, {
        type: 'doughnut',
        data: {
            labels: channelNames.map(name => data.channel_breakdown[name].name),
            datasets: [{
                data: revenues,
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Revenue by Channel'
                }
            }
        }
    });
    
    // Create detailed breakdown table
    createChannelBreakdownTable(data.channel_breakdown);
}

function createChannelBreakdownTable(breakdown) {
    const container = document.getElementById('channelBreakdown');
    
    let html = `
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Channel</th>
                    <th>Style</th>
                    <th>Monthly Videos</th>
                    <th>Est. Views</th>
                    <th>RPM</th>
                    <th>Revenue</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    Object.entries(breakdown).forEach(([id, channel]) => {
        html += `
            <tr>
                <td><strong>${channel.name}</strong></td>
                <td><span class="badge bg-primary">${channel.style}</span></td>
                <td>${channel.monthly_videos}</td>
                <td>${channel.estimated_monthly_views.toLocaleString()}</td>
                <td>$${channel.rpm}</td>
                <td><strong class="text-success">$${channel.estimated_monthly_revenue.toFixed(2)}</strong></td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function editChannel(channelId) {
    Swal.fire({
        title: 'Edit Channel',
        text: 'Channel editing functionality coming soon!',
        icon: 'info'
    });
}

function generateForChannel(channelId) {
    Swal.fire({
        title: 'Generate for Channel',
        text: 'Single channel generation coming soon!',
        icon: 'info'
    });
}

// SEO Optimization Functions
async function optimizeSingleSEO() {
    const btn = document.getElementById('optimizeSingle');
    const style = document.getElementById('seoStyle').value;
    const mood = document.getElementById('seoMood').value;
    const customTitle = document.getElementById('seoCustomTitle').value;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Optimizing...';
    
    try {
        const response = await fetch('/api/seo/optimize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                style: style,
                mood: mood,
                title: customTitle || null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSEOResults([{
                style: style,
                optimized_metadata: data.optimized_metadata,
                success: true
            }], false);
        } else {
            throw new Error(data.message || 'SEO optimization failed');
        }
        
    } catch (error) {
        Swal.fire('Error', 'SEO optimization failed: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic me-2"></i>Optimize Single Video';
    }
}

async function optimizeBatchSEO() {
    const btn = document.getElementById('optimizeBatch');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Batch Optimizing...';
    
    try {
        const response = await fetch('/api/seo/batch-optimize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ batch_size: 10 })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSEOResults(data.batch_results, true, data.batch_summary);
            
            Swal.fire({
                title: 'Batch SEO Complete!',
                html: `
                    <div class="text-start">
                        <p><strong>Videos Optimized:</strong> ${data.batch_summary.successful_optimizations}</p>
                        <p><strong>Total Estimated Views:</strong> ${data.batch_summary.total_estimated_views.toLocaleString()}</p>
                        <p><strong>Total Estimated Revenue:</strong> $${data.batch_summary.total_estimated_revenue}</p>
                        <p><strong>Average SEO Score:</strong> ${data.batch_summary.average_seo_score}/100</p>
                    </div>
                `,
                icon: 'success'
            });
        } else {
            throw new Error(data.message || 'Batch SEO optimization failed');
        }
        
    } catch (error) {
        Swal.fire('Error', 'Batch SEO optimization failed: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-rocket me-2"></i>Batch SEO Optimize (10x)';
    }
}

function showSEOResults(results, isBatch = false, batchSummary = null) {
    const resultsContainer = document.getElementById('seoResults');
    const contentContainer = document.getElementById('seoResultsContent');
    
    let html = '';
    
    if (isBatch && batchSummary) {
        html += `
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-primary">${batchSummary.successful_optimizations}</div>
                        <small>Videos Optimized</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-info">${batchSummary.total_estimated_views.toLocaleString()}</div>
                        <small>Total Est. Views</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-success">$${batchSummary.total_estimated_revenue}</div>
                        <small>Total Est. Revenue</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-warning">${batchSummary.average_seo_score}/100</div>
                        <small>Avg SEO Score</small>
                    </div>
                </div>
            </div>
            <hr>
        `;
    }
    
    // Show sample results
    const sampleResults = results.slice(0, 3);
    
    sampleResults.forEach((result, index) => {
        if (result.success) {
            const metadata = result.optimized_metadata;
            html += `
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <span class="badge bg-primary me-2">${result.style || 'Style'}</span>
                            SEO Score: ${metadata.seo_score}/100
                            <span class="badge bg-success ms-2">$${metadata.revenue_potential.estimated_revenue}</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="text-primary">Optimized Title:</h6>
                                <p class="fw-bold">${metadata.title}</p>
                                
                                <h6 class="text-primary mt-3">Key Hashtags:</h6>
                                <p>${metadata.hashtags.slice(0, 8).join(' ')}</p>
                                
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>Best upload time: ${metadata.optimal_upload_time}
                                </small>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center mb-2">
                                    <div class="h5 text-info">${metadata.estimated_views.toLocaleString()}</div>
                                    <small>Estimated Views</small>
                                </div>
                                <div class="progress mb-2" style="height: 15px;">
                                    <div class="progress-bar bg-success" 
                                         style="width: ${metadata.engagement_analysis.engagement_score}%">
                                        ${metadata.engagement_analysis.engagement_score}%
                                    </div>
                                </div>
                                <small class="text-muted">Engagement Score</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    if (results.length > 3) {
        html += `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Showing 3 of ${results.length} optimized videos. 
                <a href="/projects" class="alert-link">View all results in Projects</a>
            </div>
        `;
    }
    
    contentContainer.innerHTML = html;
    resultsContainer.classList.remove('d-none');
    
    // Update estimated views display
    const totalViews = results.reduce((sum, r) => sum + (r.success ? r.optimized_metadata.estimated_views : 0), 0);
    document.getElementById('seoEstimatedViews').textContent = totalViews.toLocaleString();
}

// Smart Thumbnail Generator Functions
async function generateSingleThumbnail() {
    const btn = document.getElementById('generateSingleThumb');
    const style = document.getElementById('thumbStyle').value;
    const title = document.getElementById('thumbTitle').value;
    const variants = document.getElementById('thumbVariants').value;
    
    if (!title.trim()) {
        Swal.fire('Error', 'Please enter a video title', 'error');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    
    try {
        const response = await fetch('/api/thumbnails/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                style: style,
                title: title,
                mood: 'engaging',
                variant_count: parseInt(variants)
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showThumbnailResults([{
                style: style,
                title: title,
                thumbnail_package: data.thumbnail_package,
                roi_analysis: data.roi_analysis,
                winner: data.winner
            }], false);
            
            // Update ROI display
            document.getElementById('thumbEstimatedROI').textContent = 
                `+$${data.roi_analysis.additional_monthly_revenue}`;
            
        } else {
            throw new Error(data.error || 'Thumbnail generation failed');
        }
        
    } catch (error) {
        Swal.fire('Error', 'Thumbnail generation failed: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate Thumbnail';
    }
}

async function batchGenerateThumbnails() {
    const btn = document.getElementById('batchGenerateThumbs');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Batch Generating...';
    
    try {
        const response = await fetch('/api/thumbnails/batch-generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ batch_size: 5 })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showThumbnailResults(data.batch_results, true, {
                total_thumbnails: data.total_thumbnails_generated,
                total_monthly_roi: data.total_monthly_roi,
                total_annual_roi: data.total_annual_roi
            });
            
            // Update ROI display
            document.getElementById('thumbEstimatedROI').textContent = 
                `+$${data.total_monthly_roi}`;
            
            Swal.fire({
                title: 'Batch Thumbnails Generated!',
                html: `
                    <div class="text-start">
                        <p><strong>Thumbnails Generated:</strong> ${data.total_thumbnails_generated}</p>
                        <p><strong>Monthly ROI Boost:</strong> +$${data.total_monthly_roi}</p>
                        <p><strong>Annual ROI Projection:</strong> +$${data.total_annual_roi}</p>
                    </div>
                `,
                icon: 'success'
            });
            
        } else {
            throw new Error(data.error || 'Batch thumbnail generation failed');
        }
        
    } catch (error) {
        Swal.fire('Error', 'Batch thumbnail generation failed: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-images me-2"></i>Batch Generate (5x)';
    }
}

function showThumbnailResults(results, isBatch = false, batchSummary = null) {
    const resultsContainer = document.getElementById('thumbResults');
    const contentContainer = document.getElementById('thumbResultsContent');
    
    let html = '';
    
    if (isBatch && batchSummary) {
        html += `
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h5 text-warning">${batchSummary.total_thumbnails}</div>
                        <small>Thumbnails Generated</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h5 text-success">+$${batchSummary.total_monthly_roi}</div>
                        <small>Monthly ROI Boost</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h5 text-info">+$${batchSummary.total_annual_roi}</div>
                        <small>Annual ROI Boost</small>
                    </div>
                </div>
            </div>
            <hr>
        `;
    }
    
    // Show sample results
    const sampleResults = results.slice(0, 3);
    
    sampleResults.forEach((result, index) => {
        const roi = result.roi_analysis;
        const winner = result.winner || result.thumbnail_package.ab_test_results.winner;
        
        html += `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <span class="badge bg-warning me-2">${result.style || 'Style'}</span>
                        CTR: ${winner.performance.ctr}%
                        <span class="badge bg-success ms-2">+$${roi.additional_monthly_revenue}</span>
                        <span class="badge bg-info ms-1">${winner.performance.performance_tier}</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="text-warning">Generated Title:</h6>
                            <p class="fw-bold">${result.title || result.video_title}</p>
                            
                            <h6 class="text-warning mt-3">Optimization Results:</h6>
                            <p>
                                <small class="text-muted">
                                    <i class="fas fa-chart-line me-1"></i>CTR Improvement: +${roi.ctr_improvement_percent}% 
                                    | <i class="fas fa-eye me-1"></i>Performance: ${winner.performance.performance_tier}
                                    | <i class="fas fa-dollar-sign me-1"></i>ROI: ${roi.roi_multiplier}x
                                </small>
                            </p>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center mb-2">
                                <div class="h6 text-success">+$${roi.additional_monthly_revenue}</div>
                                <small>Monthly Revenue Boost</small>
                            </div>
                            <div class="progress mb-2" style="height: 15px;">
                                <div class="progress-bar bg-warning" 
                                     style="width: ${Math.min(winner.performance.ctr * 8, 100)}%">
                                    ${winner.performance.ctr}%
                                </div>
                            </div>
                            <small class="text-muted">Click-Through Rate</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    if (results.length > 3) {
        html += `
            <div class="alert alert-warning">
                <i class="fas fa-info-circle me-2"></i>
                Showing 3 of ${results.length} generated thumbnail sets. 
                <a href="/projects" class="alert-link">View all results in Projects</a>
            </div>
        `;
    }
    
    contentContainer.innerHTML = html;
    resultsContainer.classList.remove('d-none');
}
</script>
{% endblock %}