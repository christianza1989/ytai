{% extends "admin_base.html" %}

{% block title %}YouTube Channels Manager - Admin Panel{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">YouTube Channels</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-0">
            <i class="fab fa-youtube text-danger me-2"></i>
            YouTube Channels Manager
        </h1>
        <p class="text-muted">Valdyti kelis YouTube kanalus, jų credentials ir muzikos stilius</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-success me-2" onclick="refreshYouTubeData()" title="Refresh YouTube Statistics">
            <i class="fas fa-sync me-1"></i>
            🔄 YouTube Data
        </button>
        <button class="btn btn-danger me-2" onclick="addNewChannel()">
            <i class="fas fa-plus me-1"></i>
            Pridėti Kanalą
        </button>
        <button class="btn btn-outline-primary" onclick="bulkOperations()">
            <i class="fas fa-tasks me-1"></i>
            Bulk Operations
        </button>
    </div>
</div>

<!-- Channel Statistics Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-white-50 mb-0">Total Channels</h6>
                        <h3 class="mb-0" id="totalChannels">0</h3>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fab fa-youtube fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-white-50 mb-0">Active Channels</h6>
                        <h3 class="mb-0" id="activeChannels">0</h3>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-white-50 mb-0">Total Subscribers</h6>
                        <h3 class="mb-0" id="totalSubscribers">0</h3>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-white-50 mb-0">Monthly Revenue</h6>
                        <h3 class="mb-0" id="monthlyRevenue">$0</h3>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Channels Management -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    YouTube Channels List
                </h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" id="channelFilter" onchange="filterChannels()">
                        <option value="all">All Channels</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                        <option value="needs_setup">Needs Setup</option>
                    </select>
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshChannels()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="channelsTable">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllChannels" onchange="toggleSelectAll()">
                                </th>
                                <th>Channel Info</th>
                                <th>Genre/Style</th>
                                <th>Status</th>
                                <th>Subscribers</th>
                                <th>Revenue</th>
                                <th>Last Upload</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="channelsTableBody">
                            <!-- Channels will be loaded here dynamically -->
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div class="mt-2">Loading channels...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Channel Modal -->
<div class="modal fade" id="channelModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="channelModalTitle">
                    <i class="fab fa-youtube text-danger me-2"></i>
                    Add New YouTube Channel
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="channelForm">
                    <input type="hidden" id="channelId" name="channel_id">
                    
                    <!-- Channel Basic Information -->
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <h6><i class="fas fa-info-circle text-primary me-2"></i>Basic Information</h6>
                            <hr>
                            
                            <div class="mb-3">
                                <label for="channelName" class="form-label">Channel Name *</label>
                                <input type="text" class="form-control" id="channelName" name="channel_name" required 
                                       placeholder="e.g., Lo-Fi Beats Central">
                            </div>
                            
                            <div class="mb-3">
                                <label for="channelUrl" class="form-label">Channel URL</label>
                                <input type="url" class="form-control" id="channelUrl" name="channel_url" 
                                       placeholder="https://youtube.com/@yourchannel">
                            </div>
                            
                            <div class="mb-3">
                                <label for="channelId" class="form-label">Channel ID</label>
                                <input type="text" class="form-control" id="channelIdInput" name="youtube_channel_id" 
                                       placeholder="UCxxxxxxxxxxxxxxxxxxxxxxx">
                            </div>
                            
                            <div class="mb-3">
                                <label for="channelDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="channelDescription" name="description" rows="3" 
                                          placeholder="Channel description and focus"></textarea>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <h6><i class="fas fa-key text-warning me-2"></i>API Credentials</h6>
                            <hr>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>OAuth Setup:</strong> You'll need YouTube Data API v3 credentials
                            </div>
                            
                            <div class="mb-3">
                                <label for="apiKey" class="form-label">YouTube API Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="apiKey" name="api_key" 
                                           placeholder="Your YouTube API Key">
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('apiKey')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="clientId" class="form-label">OAuth Client ID</label>
                                <input type="text" class="form-control" id="clientId" name="client_id" 
                                       placeholder="Your OAuth Client ID">
                            </div>
                            
                            <div class="mb-3">
                                <label for="clientSecret" class="form-label">OAuth Client Secret</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="clientSecret" name="client_secret" 
                                           placeholder="Your OAuth Client Secret">
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('clientSecret')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-primary" onclick="testConnection()">
                                    <i class="fas fa-plug me-1"></i>
                                    Test Connection
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="setupOAuth()">
                                    <i class="fas fa-cog me-1"></i>
                                    Setup OAuth
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Music Genre Selection -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h6><i class="fas fa-music text-success me-2"></i>Genre Selection & Configuration</h6>
                            <hr>
                            
                            <div class="row mb-4">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Select Music Genres (Check all that apply) *</label>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        AI will automatically rotate between selected genres for content diversity
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row" id="genreCheckboxes">
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-primary">Relaxing & Ambient</h6>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="lo-fi-hip-hop" id="genre_lofi">
                                        <label class="form-check-label" for="genre_lofi">Lo-Fi Hip Hop</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="ambient" id="genre_ambient">
                                        <label class="form-check-label" for="genre_ambient">Ambient</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="chillout" id="genre_chillout">
                                        <label class="form-check-label" for="genre_chillout">Chillout</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="meditation" id="genre_meditation">
                                        <label class="form-check-label" for="genre_meditation">Meditation</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="nature-sounds" id="genre_nature">
                                        <label class="form-check-label" for="genre_nature">Nature Sounds</label>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-success">Study & Work</h6>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="study-music" id="genre_study">
                                        <label class="form-check-label" for="genre_study">Study Music</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="focus-beats" id="genre_focus">
                                        <label class="form-check-label" for="genre_focus">Focus Beats</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="coffee-shop" id="genre_coffee">
                                        <label class="form-check-label" for="genre_coffee">Coffee Shop</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="classical" id="genre_classical">
                                        <label class="form-check-label" for="genre_classical">Classical</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="jazz" id="genre_jazz">
                                        <label class="form-check-label" for="genre_jazz">Jazz</label>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-warning">Electronic & Upbeat</h6>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="house" id="genre_house">
                                        <label class="form-check-label" for="genre_house">House</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="techno" id="genre_techno">
                                        <label class="form-check-label" for="genre_techno">Techno</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="trance" id="genre_trance">
                                        <label class="form-check-label" for="genre_trance">Trance</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="synthwave" id="genre_synthwave">
                                        <label class="form-check-label" for="genre_synthwave">Synthwave</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="drum-bass" id="genre_dnb">
                                        <label class="form-check-label" for="genre_dnb">Drum & Bass</label>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-danger">Gaming & Energy</h6>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="gaming-music" id="genre_gaming">
                                        <label class="form-check-label" for="genre_gaming">Gaming Music</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="trap" id="genre_trap">
                                        <label class="form-check-label" for="genre_trap">Trap</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="dubstep" id="genre_dubstep">
                                        <label class="form-check-label" for="genre_dubstep">Dubstep</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="rock" id="genre_rock">
                                        <label class="form-check-label" for="genre_rock">Rock</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input genre-checkbox" type="checkbox" value="workout" id="genre_workout">
                                        <label class="form-check-label" for="genre_workout">Workout Music</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="targetAudience" class="form-label">Target Audience</label>
                                    <select class="form-select" id="targetAudience" name="target_audience">
                                        <option value="general">General Audience</option>
                                        <option value="students">Students</option>
                                        <option value="workers">Office Workers</option>
                                        <option value="gamers">Gamers</option>
                                        <option value="creators">Content Creators</option>
                                        <option value="meditation">Meditation & Wellness</option>
                                        <option value="fitness">Fitness Enthusiasts</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Selected Genres</label>
                                    <div class="border p-2 rounded bg-light" id="selectedGenresDisplay" style="min-height: 38px;">
                                        <span class="text-muted">No genres selected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Scheduling Configuration -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h6><i class="fas fa-clock text-primary me-2"></i>Upload Scheduling & Automation</h6>
                            <hr>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="uploadSchedule" class="form-label">Upload Frequency</label>
                                    <select class="form-select" id="uploadSchedule" name="upload_schedule" onchange="updateScheduleOptions()">
                                        <option value="daily">Daily</option>
                                        <option value="every-2-days">Every 2 Days</option>
                                        <option value="every-3-days">Every 3 Days</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="twice-weekly">Twice Weekly</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3" id="dailyCountContainer">
                                    <label for="dailyUploadCount" class="form-label">Videos per Day</label>
                                    <select class="form-select" id="dailyUploadCount" name="daily_upload_count" onchange="updateUploadHours()">
                                        <option value="1">1 video/day</option>
                                        <option value="2">2 videos/day</option>
                                        <option value="3">3 videos/day</option>
                                        <option value="4">4 videos/day</option>
                                        <option value="5">5 videos/day</option>
                                        <option value="6">6 videos/day</option>
                                        <option value="8">8 videos/day</option>
                                        <option value="10">10 videos/day</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="vocalProbability" class="form-label">AI Vocal Decision</label>
                                    <select class="form-select" id="vocalProbability" name="vocal_probability">
                                        <option value="0.9">90% Vocal - 10% Instrumental</option>
                                        <option value="0.8" selected>80% Vocal - 20% Instrumental</option>
                                        <option value="0.7">70% Vocal - 30% Instrumental</option>
                                        <option value="0.5">50% Vocal - 50% Instrumental</option>
                                        <option value="0.3">30% Vocal - 70% Instrumental</option>
                                        <option value="0.2">20% Vocal - 80% Instrumental</option>
                                        <option value="0.1">10% Vocal - 90% Instrumental</option>
                                        <option value="0.0">100% Instrumental Only</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row" id="uploadHoursContainer">
                                <div class="col-12 mb-3">
                                    <label class="form-label">Upload Times & AI Vocal Probability per Upload</label>
                                    <div class="alert alert-info">
                                        <i class="fas fa-robot me-2"></i>
                                        AI will decide vocal vs instrumental for each upload based on these probabilities
                                    </div>
                                    <div id="uploadHoursConfig">
                                        <!-- Upload time slots will be generated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 24/7 Automation Settings -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h6><i class="fas fa-robot text-primary me-2"></i>24/7 Automation Configuration</h6>
                            <hr>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>24/7 Automation:</strong> Once enabled, the system will automatically generate music, create 16:9 thumbnails, produce videos, and upload to YouTube according to your schedule.
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-success">Core Automation</h6>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoUpload" name="auto_upload" checked>
                                            <label class="form-check-label" for="autoUpload">
                                                <strong>Enable Auto-Upload to YouTube</strong>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoThumbnails" name="auto_thumbnails" checked>
                                            <label class="form-check-label" for="autoThumbnails">
                                                <strong>Auto-Generate 16:9 Thumbnails (Ideogram 3.0)</strong>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoSEO" name="auto_seo" checked>
                                            <label class="form-check-label" for="autoSEO">
                                                <strong>Auto-Optimize SEO</strong> (Titles, Tags, Descriptions)
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="aiDecisionEnabled" name="ai_decision_enabled" checked>
                                            <label class="form-check-label" for="aiDecisionEnabled">
                                                <strong>AI-Driven Vocal/Instrumental Decisions</strong>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="text-info">Advanced Features</h6>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableAnalytics" name="enable_analytics" checked>
                                            <label class="form-check-label" for="enableAnalytics">
                                                Track Performance Analytics
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableMonetization" name="enable_monetization">
                                            <label class="form-check-label" for="enableMonetization">
                                                Enable Monetization (when eligible)
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="privacySettings" class="form-label">Default Privacy</label>
                                        <select class="form-select" id="privacySettings" name="privacy_settings">
                                            <option value="private">Private (Safe Default)</option>
                                            <option value="unlisted">Unlisted</option>
                                            <option value="public">Public</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="bg-light p-3 rounded">
                                            <h6 class="text-primary mb-2">🚀 24/7 Automation Status</h6>
                                            <div id="automationStatus" class="text-muted">
                                                Save channel to enable automation
                                            </div>
                                            <button type="button" class="btn btn-success btn-sm mt-2" id="enableAutomationBtn" onclick="enableChannelAutomation()" disabled>
                                                <i class="fas fa-play me-1"></i>Start 24/7 Automation
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveChannel()">
                    <i class="fas fa-save me-1"></i>Save Channel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Operations Modal -->
<div class="modal fade" id="bulkModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tasks text-primary me-2"></i>
                    Bulk Operations
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Selected channels: <span id="selectedChannelsCount">0</span>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Generation Operations</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="bulkGenerateMusic()">
                                <i class="fas fa-music me-1"></i>
                                Generate Music for All
                            </button>
                            <button class="btn btn-outline-info" onclick="bulkGenerateThumbnails()">
                                <i class="fas fa-image me-1"></i>
                                Generate Thumbnails
                            </button>
                            <button class="btn btn-outline-success" onclick="bulkOptimizeSEO()">
                                <i class="fas fa-search me-1"></i>
                                Optimize SEO
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Management Operations</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-warning" onclick="bulkUpdateSettings()">
                                <i class="fas fa-cog me-1"></i>
                                Update Settings
                            </button>
                            <button class="btn btn-outline-secondary" onclick="bulkExportData()">
                                <i class="fas fa-download me-1"></i>
                                Export Data
                            </button>
                            <button class="btn btn-outline-danger" onclick="bulkDeleteChannels()">
                                <i class="fas fa-trash me-1"></i>
                                Delete Selected
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// YouTube Channels Manager JavaScript

let channels = [];
let selectedChannels = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadChannels();
    updateStatistics();
    
    // Add event delegation for dynamically generated buttons
    document.addEventListener('click', function(e) {
        // Check if clicked element is a delete button
        if (e.target.closest('.btn-outline-danger')) {
            const button = e.target.closest('.btn-outline-danger');
            const channelId = button.getAttribute('data-channel-id');
            if (channelId && button.getAttribute('title') === 'Delete Channel') {
                e.preventDefault();
                deleteChannel(channelId);
            }
        }
        
        // Check if clicked element is an edit button  
        if (e.target.closest('.btn-outline-primary')) {
            const button = e.target.closest('.btn-outline-primary');
            const channelId = button.getAttribute('data-channel-id');
            if (channelId && button.getAttribute('title') === 'Edit Channel') {
                e.preventDefault();
                editChannel(channelId);
            }
        }
        
        // Check if clicked element is a refresh button
        if (e.target.closest('.btn-outline-warning')) {
            const button = e.target.closest('.btn-outline-warning');
            const channelId = button.getAttribute('data-channel-id');
            if (channelId && button.getAttribute('title') === 'Refresh YouTube Data') {
                e.preventDefault();
                refreshSingleChannelData(channelId);
            }
        }
        
        // Check if clicked element is a generate content button
        if (e.target.closest('.btn-outline-success')) {
            const button = e.target.closest('.btn-outline-success');
            const channelId = button.getAttribute('data-channel-id');
            console.log('🎬 Generate Content button clicked:', {
                channelId: channelId,
                title: button.getAttribute('title'),
                hasTitle: button.getAttribute('title') === 'Generate Content'
            });
            if (channelId && button.getAttribute('title') === 'Generate Content') {
                e.preventDefault();
                generateContent(channelId);
            }
        }
        
        // Check if clicked element is a view analytics button
        if (e.target.closest('.btn-outline-info')) {
            const button = e.target.closest('.btn-outline-info');
            const channelId = button.getAttribute('data-channel-id');
            if (channelId && button.getAttribute('title') === 'View Analytics') {
                e.preventDefault();
                viewAnalytics(channelId);
            }
        }
    });
});

// Load channels from backend
function loadChannels() {
    fetch('/api/youtube/channels/list')
        .then(response => response.json())
        .then(data => {
            console.log('API Response:', data); // Debug log
            if (data && data.channels) {
                channels = data.channels;
                console.log('Loaded channels:', channels); // Debug log
                renderChannelsTable();
                updateStatistics();
            } else {
                console.error('Failed to load channels:', data);
                loadDemoChannels();
            }
        })
        .catch(error => {
            console.error('Error loading channels:', error);
            // Load demo data for development
            loadDemoChannels();
        });
}

// Demo data for development
function loadDemoChannels() {
    channels = [
        {
            id: 1,
            name: "Lo-Fi Beats Central",
            url: "https://youtube.com/@lofibeatscentral",
            channel_id: "UC123456789012345678901",
            primary_genre: "lo-fi-hip-hop",
            status: "active",
            subscribers: 45230,
            monthly_revenue: 1250,
            last_upload: "2025-09-12",
            upload_schedule: "daily",
            auto_upload: true,
            auto_thumbnails: true,
            auto_seo: true
        },
        {
            id: 2,
            name: "Ambient Soundscapes",
            url: "https://youtube.com/@ambientsounds",
            channel_id: "UC234567890123456789012",
            primary_genre: "ambient",
            status: "active",
            subscribers: 23100,
            monthly_revenue: 890,
            last_upload: "2025-09-11",
            upload_schedule: "every-2-days",
            auto_upload: true,
            auto_thumbnails: true,
            auto_seo: true
        },
        {
            id: 3,
            name: "Study Jazz Classics",
            url: "https://youtube.com/@studyjazz",
            channel_id: "UC345678901234567890123",
            primary_genre: "jazz",
            status: "needs_setup",
            subscribers: 8950,
            monthly_revenue: 320,
            last_upload: "2025-09-08",
            upload_schedule: "weekly",
            auto_upload: false,
            auto_thumbnails: true,
            auto_seo: false
        }
    ];
    renderChannelsTable();
    updateStatistics();
}

// Render channels table
function renderChannelsTable() {
    const tbody = document.getElementById('channelsTableBody');
    
    if (channels.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <div>No channels found</div>
                    <button class="btn btn-primary mt-2" onclick="addNewChannel()">
                        <i class="fas fa-plus me-1"></i>Add Your First Channel
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = channels.map(channel => {
        // Map database fields to frontend expected fields
        const channelName = channel.channel_name || channel.name || 'Unknown Channel';
        const channelUrl = channel.channel_url || channel.url || 'URL not set';
        
        // Safely parse selected_genres with error handling
        let primaryGenre = 'Not set';
        try {
            if (channel.selected_genres) {
                if (typeof channel.selected_genres === 'string') {
                    // Try to parse as JSON first
                    try {
                        const genres = JSON.parse(channel.selected_genres);
                        primaryGenre = Array.isArray(genres) && genres.length > 0 ? genres[0] : channel.selected_genres;
                    } catch (e) {
                        // If not valid JSON, use as plain text
                        primaryGenre = channel.selected_genres;
                    }
                } else if (Array.isArray(channel.selected_genres)) {
                    primaryGenre = channel.selected_genres[0] || 'Not set';
                }
            } else if (channel.primary_genre) {
                primaryGenre = channel.primary_genre;
            }
        } catch (e) {
            console.error('Error parsing genres:', e);
            primaryGenre = 'Not set';
        }
        const status = channel.status || 'active';
        const subscribers = channel.subscribers || 0;
        const monthlyRevenue = channel.monthly_revenue || 0;
        const lastUpload = channel.last_upload;
        const uploadSchedule = channel.upload_schedule || 'Not set';
        const channelId = channel.id || 0;
        
        // Debug: Log channel ID for template
        console.log('🎬 Rendering channel ID in template:', channelId, 'from channel.id:', channel.id);
        
        const statusBadge = getStatusBadge(status);
        const lastUploadFormatted = formatDate(lastUpload);
        
        console.log('Rendering channel:', { 
            channelId, 
            channelName, 
            channelUrl, 
            fullChannel: channel 
        }); // Debug log
        
        return `
            <tr>
                <td>
                    <input type="checkbox" class="channel-select" value="${channelId}" 
                           onchange="updateSelectedChannels()">
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center text-white" 
                                 style="width: 40px; height: 40px;">
                                <i class="fab fa-youtube"></i>
                            </div>
                        </div>
                        <div>
                            <div class="fw-bold">${channelName}</div>
                            <div class="small text-muted">${channelUrl}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-primary">${formatGenre(primaryGenre)}</span>
                    <div class="small text-muted mt-1">${uploadSchedule}</div>
                </td>
                <td>${statusBadge}</td>
                <td>
                    <div class="fw-bold">${formatNumber(subscribers)}</div>
                    <div class="small text-muted">subscribers</div>
                </td>
                <td>
                    <div class="fw-bold text-success">$${formatNumber(monthlyRevenue)}</div>
                    <div class="small text-muted">monthly</div>
                </td>
                <td>
                    <div>${lastUploadFormatted}</div>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" 
                                title="Edit Channel" data-channel-id="${channelId}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" 
                                title="Refresh YouTube Data" data-channel-id="${channelId}">
                            <i class="fas fa-sync"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" 
                                title="View Analytics" data-channel-id="${channelId}">
                            <i class="fas fa-chart-line"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" 
                                title="Generate Content" data-channel-id="${channelId}">
                            <i class="fas fa-magic"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                                title="Delete Channel" data-channel-id="${channelId}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Helper functions
function getStatusBadge(status) {
    switch (status) {
        case 'active':
            return '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Active</span>';
        case 'inactive':
            return '<span class="badge bg-secondary"><i class="fas fa-pause me-1"></i>Inactive</span>';
        case 'needs_setup':
            return '<span class="badge bg-warning"><i class="fas fa-exclamation me-1"></i>Setup Required</span>';
        case 'error':
            return '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Error</span>';
        default:
            return '<span class="badge bg-light text-dark">Unknown</span>';
    }
}

function formatGenre(genre) {
    if (!genre) return 'Not set';
    return genre.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatNumber(num) {
    // Handle undefined, null, or non-numeric values
    if (num === undefined || num === null || isNaN(num)) {
        return '0';
    }
    
    const numValue = Number(num);
    if (numValue >= 1000000) return (numValue / 1000000).toFixed(1) + 'M';
    if (numValue >= 1000) return (numValue / 1000).toFixed(1) + 'K';
    return numValue.toString();
}

function formatDate(dateStr) {
    if (!dateStr) return 'Never';
    const date = new Date(dateStr);
    const today = new Date();
    const diffTime = Math.abs(today - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return 'Today';
    if (diffDays === 2) return 'Yesterday';
    if (diffDays <= 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
}

// Update statistics
function updateStatistics() {
    // Try to get real statistics from API
    fetch('/api/youtube/channels/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.statistics) {
                const stats = data.statistics;
                document.getElementById('totalChannels').textContent = stats.total_channels;
                document.getElementById('activeChannels').textContent = stats.active_channels;
                document.getElementById('totalSubscribers').textContent = formatNumber(stats.total_subscribers);
                document.getElementById('monthlyRevenue').textContent = '$' + formatNumber(stats.total_revenue);
            } else {
                updateStatisticsFromLocal();
            }
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
            updateStatisticsFromLocal();
        });
}

function updateStatisticsFromLocal() {
    // Fallback to local calculation
    document.getElementById('totalChannels').textContent = channels.length;
    document.getElementById('activeChannels').textContent = channels.filter(c => c.status === 'active').length;
    document.getElementById('totalSubscribers').textContent = formatNumber(
        channels.reduce((sum, c) => sum + (c.subscribers || 0), 0)
    );
    document.getElementById('monthlyRevenue').textContent = '$' + formatNumber(
        channels.reduce((sum, c) => sum + (c.monthly_revenue || 0), 0)
    );
}

// Channel management functions
function addNewChannel() {
    document.getElementById('channelModalTitle').innerHTML = `
        <i class="fab fa-youtube text-danger me-2"></i>Add New YouTube Channel
    `;
    document.getElementById('channelForm').reset();
    document.getElementById('channelId').value = '';
    
    // Reset genre selection
    document.querySelectorAll('.genre-checkbox').forEach(cb => cb.checked = false);
    updateSelectedGenres();
    
    // Reset automation status
    const automationBtn = document.getElementById('enableAutomationBtn');
    const automationStatus = document.getElementById('automationStatus');
    
    automationStatus.innerHTML = `
        <div class="text-muted">
            Save channel to enable automation
        </div>
    `;
    automationBtn.disabled = true;
    automationBtn.classList.remove('btn-secondary');
    automationBtn.classList.add('btn-success');
    automationBtn.innerHTML = '<i class="fas fa-play me-1"></i>Start 24/7 Automation';
    
    // Initialize upload hours
    updateScheduleOptions();
    
    const modal = new bootstrap.Modal(document.getElementById('channelModal'));
    modal.show();
}

function editChannel(channelId) {
    console.log('Edit channel called with ID:', channelId, 'type:', typeof channelId); // Debug log
    console.log('Available channels:', channels); // Debug log
    
    // Try to find channel with different ID comparisons
    let channel = channels.find(c => c.id === channelId);
    if (!channel) {
        channel = channels.find(c => c.id === parseInt(channelId));
    }
    if (!channel) {
        channel = channels.find(c => String(c.id) === String(channelId));
    }
    
    if (!channel) {
        console.error('Channel not found for ID:', channelId);
        console.error('Available channel IDs:', channels.map(c => c.id));
        showToast('Channel not found', 'error');
        return;
    }
    
    const channelName = channel.channel_name || channel.name || 'Unknown Channel';
    
    document.getElementById('channelModalTitle').innerHTML = `
        <i class="fab fa-youtube text-danger me-2"></i>Edit Channel: ${channelName}
    `;
    
    // Populate basic form data
    document.getElementById('channelId').value = channel.id;
    document.getElementById('channelName').value = channel.channel_name || channel.name || '';
    document.getElementById('channelUrl').value = channel.channel_url || channel.url || '';
    document.getElementById('channelIdInput').value = channel.youtube_channel_id || channel.channel_id || '';
    document.getElementById('channelDescription').value = channel.description || '';
    
    // Populate API credentials - FIXED: Now loading saved credentials!
    console.log('📥 Frontend editChannel - API credentials from channel data:', {
        api_key: channel.api_key ? '***set***' : 'empty/missing',
        client_id: channel.client_id ? '***set***' : 'empty/missing',
        client_secret: channel.client_secret ? '***set***' : 'empty/missing'
    });
    
    document.getElementById('apiKey').value = channel.api_key || '';
    document.getElementById('clientId').value = channel.client_id || '';
    document.getElementById('clientSecret').value = channel.client_secret || '';
    
    console.log('📝 Frontend editChannel - Form fields after population:', {
        apiKey: document.getElementById('apiKey').value ? '***set***' : 'empty',
        clientId: document.getElementById('clientId').value ? '***set***' : 'empty',
        clientSecret: document.getElementById('clientSecret').value ? '***set***' : 'empty'
    });
    
    // Populate genre selection
    document.querySelectorAll('.genre-checkbox').forEach(cb => cb.checked = false);
    
    // Safely parse selected_genres JSON
    let selectedGenres = [];
    try {
        if (channel.selected_genres) {
            if (typeof channel.selected_genres === 'string') {
                selectedGenres = JSON.parse(channel.selected_genres);
            } else if (Array.isArray(channel.selected_genres)) {
                selectedGenres = channel.selected_genres;
            }
        }
    } catch (e) {
        console.error('Error parsing selected_genres:', e);
        selectedGenres = [];
    }
    
    selectedGenres.forEach(genre => {
        const checkbox = document.querySelector(`.genre-checkbox[value="${genre}"]`);
        if (checkbox) checkbox.checked = true;
    });
    updateSelectedGenres();
    
    // Populate target audience
    document.getElementById('targetAudience').value = channel.target_audience || 'general';
    
    // Populate schedule settings
    document.getElementById('uploadSchedule').value = channel.upload_schedule || 'daily';
    document.getElementById('dailyUploadCount').value = channel.daily_upload_count || 1;
    document.getElementById('vocalProbability').value = channel.vocal_probability || 0.8;
    
    // Populate automation settings
    document.getElementById('autoUpload').checked = channel.auto_upload !== false;
    document.getElementById('autoThumbnails').checked = channel.auto_thumbnails !== false;
    document.getElementById('autoSEO').checked = channel.auto_seo !== false;
    document.getElementById('aiDecisionEnabled').checked = channel.ai_decision_enabled !== false;
    document.getElementById('enableAnalytics').checked = channel.enable_analytics !== false;
    document.getElementById('enableMonetization').checked = channel.enable_monetization || false;
    document.getElementById('privacySettings').value = channel.privacy_settings || 'private';
    
    // Update schedule options and upload hours
    updateScheduleOptions();
    
    // Populate upload hours if available
    if (channel.upload_hours && channel.upload_hours.length > 0) {
        setTimeout(() => {
            channel.upload_hours.forEach((hourConfig, index) => {
                const timeInput = document.querySelector(`input[name="upload_hour_${index}"]`);
                const vocalProbInput = document.querySelector(`select[name="vocal_prob_${index}"]`);
                
                if (timeInput && vocalProbInput) {
                    const timeStr = String(hourConfig.hour).padStart(2, '0') + ':' + String(hourConfig.minute || 0).padStart(2, '0');
                    timeInput.value = timeStr;
                    vocalProbInput.value = hourConfig.vocal_probability || 0.8;
                }
            });
        }, 100);
    }
    
    // Update automation status
    const automationBtn = document.getElementById('enableAutomationBtn');
    const automationStatus = document.getElementById('automationStatus');
    
    if (channel.automation_enabled) {
        automationStatus.innerHTML = `
            <div class="text-success">
                <i class="fas fa-check-circle me-1"></i>
                Automation Active${channel.automation_next_run ? ' - Next run: ' + new Date(channel.automation_next_run).toLocaleString() : ''}
            </div>
        `;
        automationBtn.textContent = 'Automation Running';
        automationBtn.disabled = true;
        automationBtn.classList.remove('btn-success');
        automationBtn.classList.add('btn-secondary');
    } else {
        automationStatus.innerHTML = `
            <div class="text-info">
                <i class="fas fa-info-circle me-1"></i>
                Ready to enable automation
            </div>
        `;
        automationBtn.disabled = false;
        automationBtn.classList.remove('btn-secondary');
        automationBtn.classList.add('btn-success');
        automationBtn.innerHTML = '<i class="fas fa-play me-1"></i>Start 24/7 Automation';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('channelModal'));
    modal.show();
}

function saveChannel() {
    const form = document.getElementById('channelForm');
    const formData = new FormData(form);
    const channelData = Object.fromEntries(formData.entries());
    
    // Collect selected genres
    const selectedGenres = Array.from(document.querySelectorAll('.genre-checkbox:checked')).map(cb => cb.value);
    channelData.selected_genres = selectedGenres;
    
    // Collect upload hours configuration
    const dailyCount = parseInt(channelData.daily_upload_count || 1);
    const uploadHours = [];
    
    if (channelData.upload_schedule === 'daily') {
        for (let i = 0; i < dailyCount; i++) {
            const timeInput = document.querySelector(`input[name="upload_hour_${i}"]`);
            const vocalProbInput = document.querySelector(`select[name="vocal_prob_${i}"]`);
            
            if (timeInput && vocalProbInput) {
                const [hour, minute] = timeInput.value.split(':');
                uploadHours.push({
                    hour: parseInt(hour),
                    minute: parseInt(minute || 0),
                    vocal_probability: parseFloat(vocalProbInput.value)
                });
            }
        }
    } else {
        // Single upload for non-daily schedules
        const timeInput = document.querySelector('input[name="upload_time"]');
        const vocalProbInput = document.querySelector('select[name="single_vocal_prob"]');
        
        if (timeInput && vocalProbInput) {
            const [hour, minute] = timeInput.value.split(':');
            uploadHours.push({
                hour: parseInt(hour),
                minute: parseInt(minute || 0),
                vocal_probability: parseFloat(vocalProbInput.value)
            });
        }
    }
    
    channelData.upload_hours = uploadHours;
    
    // Validate required fields
    if (!channelData.channel_name) {
        showToast('Please enter channel name', 'error');
        return;
    }
    
    if (selectedGenres.length === 0) {
        showToast('Please select at least one music genre', 'error');
        return;
    }
    
    if (uploadHours.length === 0) {
        showToast('Please configure upload times', 'error');
        return;
    }
    
    // Show loading
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    showLoading(saveBtn);
    
    // Debug: Log channel data being sent
    console.log('💾 Saving channel data:', channelData);
    console.log('🔑 API credentials in data:', {
        api_key: channelData.api_key ? '***set***' : 'empty',
        client_id: channelData.client_id ? '***set***' : 'empty',
        client_secret: channelData.client_secret ? '***set***' : 'empty'
    });
    
    // Send to API
    fetch('/api/youtube/channels/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(channelData)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading(saveBtn, originalText);
        
        if (data.success) {
            showToast(data.message, 'success');
            
            // Update channel ID for automation
            if (data.channel && data.channel.id) {
                document.getElementById('channelId').value = data.channel.id;
                
                // Enable automation button
                const automationBtn = document.getElementById('enableAutomationBtn');
                if (automationBtn) {
                    automationBtn.disabled = false;
                    document.getElementById('automationStatus').innerHTML = `
                        <div class="text-info">
                            <i class="fas fa-info-circle me-1"></i>
                            Channel saved successfully. Ready to enable automation.
                        </div>
                    `;
                }
            }
            
            // Update local channels array
            if (channelData.channel_id) {
                // Update existing
                const index = channels.findIndex(c => c.id === parseInt(channelData.channel_id));
                if (index !== -1) {
                    channels[index] = data.channel;
                }
            } else {
                // Add new
                channels.push(data.channel);
            }
            
            renderChannelsTable();
            updateStatistics();
            
            // Don't close modal immediately, let user enable automation
            showToast('Channel saved! You can now enable 24/7 automation above.', 'info');
        } else {
            showToast(data.message || 'Failed to save channel', 'error');
        }
    })
    .catch(error => {
        hideLoading(saveBtn, originalText);
        console.error('Error saving channel:', error);
        showToast('Error saving channel. Please try again.', 'error');
    });
}

function deleteChannel(channelId) {
    console.log('Delete channel called with ID:', channelId, 'type:', typeof channelId); // Debug log
    console.log('Available channels:', channels); // Debug log
    
    // Try to find channel with different ID comparisons
    let channel = channels.find(c => c.id === channelId);
    if (!channel) {
        channel = channels.find(c => c.id === parseInt(channelId));
    }
    if (!channel) {
        channel = channels.find(c => String(c.id) === String(channelId));
    }
    
    if (!channel) {
        console.error('Channel not found for ID:', channelId);
        console.error('Available channel IDs:', channels.map(c => c.id));
        showToast('Channel not found', 'error');
        return;
    }
    
    const channelName = channel.channel_name || channel.name || 'Unknown Channel';
    
    // Use simple confirm instead of SweetAlert for testing
    if (confirm(`Are you sure you want to delete "${channelName}"? This action cannot be undone.`)) {
        console.log('Deleting channel ID:', channelId); // Debug log
        // Call API to delete
        fetch(`/api/youtube/channels/${channelId}/delete`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                channels = channels.filter(c => c.id !== parseInt(channelId));
                renderChannelsTable();
                updateStatistics();
                showToast('Channel deleted successfully', 'success');
            } else {
                showToast(data.message || 'Failed to delete channel', 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting channel:', error);
            showToast('Error deleting channel. Please try again.', 'error');
        });
    }
}

// Utility functions
function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        button.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        button.className = 'fas fa-eye';
    }
}

function testConnection() {
    const apiKey = document.getElementById('apiKey').value;
    
    // Allow empty API key - will use environment variables as fallback
    if (!apiKey) {
        console.log('No API key provided - will use environment variables');
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    showLoading(btn);
    
    // Test connection using per-channel API key or env fallback
    fetch('/api/youtube/test-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ api_key: apiKey || '' })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading(btn, originalText);
        
        if (data.success) {
            showToast(`✅ Connection successful! API Version: ${data.api_version}`, 'success');
        } else {
            showToast(`❌ Connection failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        hideLoading(btn, originalText);
        console.error('Error testing connection:', error);
        showToast('❌ Connection test failed. Please try again.', 'error');
    });
}

function setupOAuth() {
    Swal.fire({
        title: 'OAuth Setup Guide',
        html: `
            <div class="text-start">
                <h6>Follow these steps:</h6>
                <ol>
                    <li>Go to <a href="https://console.developers.google.com/" target="_blank">Google Console</a></li>
                    <li>Create a new project or select existing</li>
                    <li>Enable YouTube Data API v3</li>
                    <li>Create credentials (OAuth 2.0 Client ID)</li>
                    <li>Add authorized redirect URIs</li>
                    <li>Copy Client ID and Client Secret</li>
                </ol>
                <div class="alert alert-info mt-3">
                    <strong>Redirect URI:</strong> ${window.location.origin}/oauth/youtube/callback
                </div>
            </div>
        `,
        width: 600,
        confirmButtonText: 'Got it!'
    });
}

function generateContent(channelId) {
    console.log('🎬 generateContent called with channelId:', channelId, 'type:', typeof channelId);
    console.log('🎬 Available channels:', channels.map(c => ({id: c.id, name: c.channel_name || c.name, type: typeof c.id})));
    
    // Try to find channel with different ID comparisons (same as editChannel function)
    let channel = channels.find(c => c.id === channelId);
    if (!channel) {
        channel = channels.find(c => c.id === parseInt(channelId));
    }
    if (!channel) {
        channel = channels.find(c => String(c.id) === String(channelId));
    }
    
    if (!channel) {
        console.error('🎬 Channel not found for ID:', channelId);
        console.error('🎬 Available channel IDs:', channels.map(c => c.id));
        showToast('Channel not found', 'error');
        return;
    }
    
    console.log('🎬 Found channel:', channel.channel_name || channel.name);
    
    Swal.fire({
        title: `Generate Content for ${channel.name}`,
        html: `
            <div class="text-start">
                <h6>Select content type:</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="generateMusic(${channelId})">
                        <i class="fas fa-music me-1"></i> Generate Music Track
                    </button>
                    <button class="btn btn-outline-info" onclick="generateThumbnail(${channelId})">
                        <i class="fas fa-image me-1"></i> Generate Thumbnail
                    </button>
                    <button class="btn btn-outline-success" onclick="generateFullVideo(${channelId})">
                        <i class="fas fa-video me-1"></i> Generate Full Video
                    </button>
                </div>
            </div>
        `,
        showConfirmButton: false,
        width: 400
    });
}

function generateMusic(channelId) {
    Swal.close();
    
    fetch(`/api/youtube/channels/${channelId}/generate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ type: 'music' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('🎵 Music generation started! Redirecting to Batch Operations...', 'info');
            // Optionally redirect to task monitor
            if (data.task_id) {
                setTimeout(() => {
                    window.location.href = `/batch`;
                }, 2000);
            }
        } else {
            showToast('Failed to start music generation', 'error');
        }
    })
    .catch(error => {
        console.error('Error starting music generation:', error);
        showToast('Error starting music generation', 'error');
    });
}

function generateThumbnail(channelId) {
    Swal.close();
    
    fetch(`/api/youtube/channels/${channelId}/generate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ type: 'thumbnail' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('🖼️ Thumbnail generation started with Ideogram 3.0!', 'info');
            if (data.task_id) {
                setTimeout(() => {
                    window.location.href = `/batch`;
                }, 2000);
            }
        } else {
            showToast('Failed to start thumbnail generation', 'error');
        }
    })
    .catch(error => {
        console.error('Error starting thumbnail generation:', error);
        showToast('Error starting thumbnail generation', 'error');
    });
}

function generateFullVideo(channelId) {
    Swal.close();
    
    fetch(`/api/youtube/channels/${channelId}/generate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ type: 'full_video' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('🎬 Full video generation started! Redirecting to Batch Operations...', 'info');
            if (data.task_id) {
                setTimeout(() => {
                    window.location.href = `/batch`;
                }, 2000);
            }
        } else {
            showToast('Failed to start full video generation', 'error');
        }
    })
    .catch(error => {
        console.error('Error starting full video generation:', error);
        showToast('Error starting full video generation', 'error');
    });
}

function viewAnalytics(channelId) {
    const channel = channels.find(c => c.id === channelId);
    if (!channel) return;
    
    // Redirect to analytics page with channel filter
    window.location.href = `/analytics?channel=${channelId}`;
}

// Selection and bulk operations
function updateSelectedChannels() {
    selectedChannels = Array.from(document.querySelectorAll('.channel-select:checked')).map(cb => parseInt(cb.value));
    document.getElementById('selectedChannelsCount').textContent = selectedChannels.length;
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAllChannels');
    const checkboxes = document.querySelectorAll('.channel-select');
    
    checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
    });
    
    updateSelectedChannels();
}

function filterChannels() {
    const filter = document.getElementById('channelFilter').value;
    // Implementation for filtering channels
    loadChannels(); // For now, just reload
}

function refreshChannels() {
    showToast('Refreshing local data...', 'info');
    loadChannels();
}

// New function to refresh YouTube data via API
function refreshYouTubeData() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    
    showToast('🔄 Fetching fresh data from YouTube API...', 'info');
    
    fetch('/api/youtube/refresh-channel-stats', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({}) // Empty body = refresh all channels
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success) {
            showToast(`✅ Successfully updated ${data.updated_channels} channels! Used ${data.quota_used} API quota.`, 'success');
            
            // Reload channels to show updated data
            setTimeout(() => {
                loadChannels();
                updateStatistics();
            }, 1000);
            
            // Show detailed results if there were errors
            if (data.errors && data.errors.length > 0) {
                setTimeout(() => {
                    showToast(`⚠️ Some channels had issues: ${data.errors.slice(0, 2).join(', ')}`, 'warning');
                }, 3000);
            }
        } else {
            showToast(`❌ Failed to refresh YouTube data: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        console.error('Error refreshing YouTube data:', error);
        showToast('❌ Failed to refresh YouTube data. Please check your API configuration.', 'error');
    });
}

// Function to refresh individual channel YouTube data
function refreshSingleChannelData(channelId) {
    console.log('Refreshing YouTube data for channel ID:', channelId);
    
    fetch('/api/youtube/refresh-channel-stats', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ channel_id: channelId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('✅ Channel data refreshed successfully!', 'success');
            loadChannels(); // Reload to show updated data
        } else {
            showToast(`❌ Failed to refresh channel: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error refreshing channel:', error);
        showToast('❌ Failed to refresh channel data.', 'error');
    });
}

function bulkOperations() {
    if (selectedChannels.length === 0) {
        showToast('Please select at least one channel', 'warning');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('bulkModal'));
    modal.show();
}

// Bulk operation functions
function bulkGenerateMusic() {
    showToast(`🎵 Generating music for ${selectedChannels.length} channels...`, 'info');
    bootstrap.Modal.getInstance(document.getElementById('bulkModal')).hide();
}

function bulkGenerateThumbnails() {
    showToast(`🖼️ Generating thumbnails with Ideogram 3.0 for ${selectedChannels.length} channels...`, 'info');
    bootstrap.Modal.getInstance(document.getElementById('bulkModal')).hide();
}

function bulkOptimizeSEO() {
    showToast(`🔍 Optimizing SEO for ${selectedChannels.length} channels...`, 'info');
    bootstrap.Modal.getInstance(document.getElementById('bulkModal')).hide();
}

function bulkUpdateSettings() {
    showToast(`⚙️ Updating settings for ${selectedChannels.length} channels...`, 'info');
    bootstrap.Modal.getInstance(document.getElementById('bulkModal')).hide();
}

function bulkExportData() {
    const selectedChannelData = channels.filter(c => selectedChannels.includes(c.id));
    const dataStr = JSON.stringify(selectedChannelData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `youtube_channels_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showToast('Channel data exported successfully!', 'success');
    bootstrap.Modal.getInstance(document.getElementById('bulkModal')).hide();
}

function bulkDeleteChannels() {
    Swal.fire({
        title: 'Delete Selected Channels?',
        text: `This will permanently delete ${selectedChannels.length} channels. This action cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: `Yes, delete ${selectedChannels.length} channels!`
    }).then((result) => {
        if (result.isConfirmed) {
            channels = channels.filter(c => !selectedChannels.includes(c.id));
            selectedChannels = [];
            renderChannelsTable();
            updateStatistics();
            showToast('Selected channels deleted successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('bulkModal')).hide();
        }
    });
}

// Genre selection management
function updateSelectedGenres() {
    const checkboxes = document.querySelectorAll('.genre-checkbox:checked');
    const display = document.getElementById('selectedGenresDisplay');
    
    if (checkboxes.length === 0) {
        display.innerHTML = '<span class="text-muted">No genres selected</span>';
        return;
    }
    
    const genres = Array.from(checkboxes).map(cb => {
        const label = document.querySelector(`label[for="${cb.id}"]`).textContent;
        return `<span class="badge bg-primary me-1">${label}</span>`;
    });
    
    display.innerHTML = genres.join('');
}

// Update schedule options based on frequency
function updateScheduleOptions() {
    const schedule = document.getElementById('uploadSchedule').value;
    const dailyContainer = document.getElementById('dailyCountContainer');
    
    if (schedule === 'daily') {
        dailyContainer.style.display = 'block';
        updateUploadHours();
    } else {
        dailyContainer.style.display = 'none';
        // For non-daily schedules, show single time picker
        document.getElementById('uploadHoursConfig').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Upload Time</label>
                    <input type="time" class="form-control" name="upload_time" value="14:00">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Vocal Probability</label>
                    <select class="form-select" name="single_vocal_prob">
                        <option value="0.8" selected>80% Vocal</option>
                        <option value="0.5">50% Vocal</option>
                        <option value="0.2">20% Vocal</option>
                        <option value="0.0">100% Instrumental</option>
                    </select>
                </div>
            </div>
        `;
    }
}

// Update upload hours configuration based on daily count
function updateUploadHours() {
    const count = parseInt(document.getElementById('dailyUploadCount').value);
    const container = document.getElementById('uploadHoursConfig');
    
    const defaultTimes = [6, 8, 10, 12, 14, 16, 18, 20, 22, 0]; // 24-hour format
    const defaultVocalProb = parseFloat(document.getElementById('vocalProbability').value);
    
    let html = '<div class="row">';
    
    for (let i = 0; i < count; i++) {
        const hour = defaultTimes[i] || (14 + i);
        const timeStr = String(hour).padStart(2, '0') + ':00';
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-2">Upload ${i + 1}</h6>
                        <div class="mb-2">
                            <label class="form-label small">Time</label>
                            <input type="time" class="form-control form-control-sm" 
                                   name="upload_hour_${i}" value="${timeStr}">
                        </div>
                        <div class="mb-0">
                            <label class="form-label small">Vocal Probability</label>
                            <select class="form-select form-select-sm" name="vocal_prob_${i}">
                                <option value="0.9" ${defaultVocalProb >= 0.85 ? 'selected' : ''}>90% Vocal</option>
                                <option value="0.8" ${defaultVocalProb >= 0.75 && defaultVocalProb < 0.85 ? 'selected' : ''}>80% Vocal</option>
                                <option value="0.7" ${defaultVocalProb >= 0.65 && defaultVocalProb < 0.75 ? 'selected' : ''}>70% Vocal</option>
                                <option value="0.5" ${defaultVocalProb >= 0.45 && defaultVocalProb < 0.65 ? 'selected' : ''}>50% Vocal</option>
                                <option value="0.3" ${defaultVocalProb >= 0.25 && defaultVocalProb < 0.45 ? 'selected' : ''}>30% Vocal</option>
                                <option value="0.2" ${defaultVocalProb >= 0.15 && defaultVocalProb < 0.25 ? 'selected' : ''}>20% Vocal</option>
                                <option value="0.1" ${defaultVocalProb >= 0.05 && defaultVocalProb < 0.15 ? 'selected' : ''}>10% Vocal</option>
                                <option value="0.0" ${defaultVocalProb < 0.05 ? 'selected' : ''}>Instrumental</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

// Enable 24/7 automation for channel
function enableChannelAutomation() {
    const channelId = document.getElementById('channelId').value;
    
    if (!channelId) {
        showToast('Please save the channel first', 'warning');
        return;
    }
    
    const btn = document.getElementById('enableAutomationBtn');
    const originalText = btn.innerHTML;
    showLoading(btn);
    
    fetch(`/api/youtube/channels/${channelId}/enable-automation`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        hideLoading(btn, originalText);
        
        if (data.success) {
            showToast('🚀 24/7 Automation enabled! System will start generating content automatically.', 'success');
            document.getElementById('automationStatus').innerHTML = `
                <div class="text-success">
                    <i class="fas fa-check-circle me-1"></i>
                    Automation Active - Next run: ${new Date(data.next_run).toLocaleString()}
                </div>
            `;
            btn.textContent = 'Automation Running';
            btn.disabled = true;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
        } else {
            showToast(data.message || 'Failed to enable automation', 'error');
        }
    })
    .catch(error => {
        hideLoading(btn, originalText);
        console.error('Error enabling automation:', error);
        showToast('Error enabling automation', 'error');
    });
}

// Add event listeners for genre selection
document.addEventListener('DOMContentLoaded', function() {
    // Genre checkbox listeners
    document.querySelectorAll('.genre-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedGenres);
    });
    
    // Initialize upload hours
    updateUploadHours();
    updateScheduleOptions();
});

// Initialize page message
showToast('🎯 YouTube Channels Manager loaded - Ready to manage your empire!', 'success');

</script>
{% endblock %}