{% extends "admin_base.html" %}

{% block title %}ðŸŽ¬ Video Gallery - Generated Videos{% endblock %}

{% block extra_css %}
<style>
/* Video Gallery Styles */
.video-gallery-container {
    max-width: 1400px;
    margin: 0 auto;
}

.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.stat-card {
    transition: transform 0.3s ease;
    border-radius: 10px;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.video-card {
    border-radius: 16px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    margin-bottom: 1.5rem;
}

.video-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

.video-card .card {
    border: none;
    border-radius: 16px;
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.video-info {
    padding: 1.5rem;
}

.video-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
    line-height: 1.4;
}

.video-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin: 1rem 0;
    font-size: 0.9rem;
    color: #666;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.status-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
}

.status-ready {
    background: #e8f5e8;
    color: #27ae60;
}

.status-uploaded {
    background: #e3f2fd;
    color: #3498db;
}

.status-uploading {
    background: #fff3e0;
    color: #f39c12;
}

.status-failed {
    background: #ffebee;
    color: #e74c3c;
}

.video-actions {
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

.btn-custom {
    border-radius: 25px;
    padding: 0.5rem 1.2rem;
    font-weight: 500;
    border: none;
    transition: all 0.3s ease;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.btn-upload {
    background: #27ae60;
    color: white;
}

.btn-upload:hover {
    background: #229954;
    transform: translateY(-2px);
    color: white;
}

.btn-preview {
    background: #3498db;
    color: white;
}

.btn-preview:hover {
    background: #2980b9;
    color: white;
}

.btn-delete {
    background: #e74c3c;
    color: white;
}

.btn-delete:hover {
    background: #c0392b;
    color: white;
}

.btn-download {
    background: #f39c12;
    color: white;
}

.btn-download:hover {
    background: #e67e22;
    color: white;
}

.video-thumbnail {
    width: 120px;
    height: 68px;
    background: #f0f0f0;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
    font-size: 2rem;
    margin-right: 1rem;
    flex-shrink: 0;
}

.video-content {
    flex-grow: 1;
}

.video-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.progress-container {
    display: none;
    margin-top: 1rem;
}

.upload-progress {
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    background: #f0f0f0;
}

.upload-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #27ae60, #2ecc71);
    width: 0%;
    transition: width 0.3s ease;
}

@media (max-width: 768px) {
    .video-header {
        flex-direction: column;
    }
    
    .video-thumbnail {
        margin-right: 0;
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="video-gallery-container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1">
                            <i class="fas fa-video me-2"></i>
                            Video Gallery
                        </h2>
                        <p class="mb-0 opacity-75">Manage and upload your generated videos</p>
                    </div>
                    <button class="btn btn-outline-light" onclick="refreshGallery()">
                        <i class="fas fa-refresh me-1"></i> Refresh
                    </button>
                </div>
                
                <!-- Statistics -->
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card border-0 bg-light text-center p-3">
                                <i class="fas fa-video fa-2x text-primary mb-2"></i>
                                <h3 class="mb-1" id="total-videos">-</h3>
                                <p class="mb-0 text-muted">Total Videos</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card border-0 bg-light text-center p-3">
                                <i class="fas fa-upload fa-2x text-success mb-2"></i>
                                <h3 class="mb-1" id="ready-videos">-</h3>
                                <p class="mb-0 text-muted">Ready to Upload</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card border-0 bg-light text-center p-3">
                                <i class="fas fa-youtube fa-2x text-info mb-2"></i>
                                <h3 class="mb-1" id="uploaded-videos">-</h3>
                                <p class="mb-0 text-muted">Uploaded</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card border-0 bg-light text-center p-3">
                                <i class="fas fa-hdd fa-2x text-warning mb-2"></i>
                                <h3 class="mb-1" id="total-size">-</h3>
                                <p class="mb-0 text-muted">Storage Used</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-4 col-md-6">
                            <label class="form-label">Filter by Status:</label>
                            <select class="form-select" id="statusFilter" onchange="filterVideos()">
                                <option value="">All Videos</option>
                                <option value="ready">Ready to Upload</option>
                                <option value="uploaded">Uploaded</option>
                                <option value="uploading">Uploading</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <label class="form-label">Filter by Genre:</label>
                            <select class="form-select" id="genreFilter" onchange="filterVideos()">
                                <option value="">All Genres</option>
                                <option value="Electronic">Electronic</option>
                                <option value="Ambient">Ambient</option>
                                <option value="Classical">Classical</option>
                                <option value="Jazz">Jazz</option>
                                <option value="Rock">Rock</option>
                                <option value="Pop">Pop</option>
                            </select>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <label class="form-label">Vocal Type:</label>
                            <select class="form-select" id="vocalFilter" onchange="filterVideos()">
                                <option value="">All Types</option>
                                <option value="vocal">Vocal</option>
                                <option value="instrumental">Instrumental</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Gallery -->
    <div class="row">
        <div class="col-12">
            <div class="loading-spinner text-center" id="loading">
                <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
                <p>Loading videos...</p>
            </div>

            <div id="video-gallery">
                <!-- Videos will be loaded here -->
            </div>

            <div class="text-center mt-4" id="no-videos" style="display: none;">
                <div class="card border-0 bg-light">
                    <div class="card-body p-5">
                        <i class="fas fa-video fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No Videos Found</h4>
                        <p class="text-muted">Generated videos will appear here automatically.<br>
                           <a href="{{ url_for('music_gallery') }}" class="text-primary">Generate some videos</a> to get started!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-upload me-2"></i>
                        Upload to YouTube
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Channel:</label>
                        <select class="form-select" id="uploadChannelSelect">
                            <option value="">Loading channels...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Video Title:</label>
                        <input type="text" class="form-control" id="uploadVideoTitle" maxlength="100">
                        <div class="form-text">Maximum 100 characters</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description:</label>
                        <textarea class="form-control" id="uploadVideoDescription" rows="4" maxlength="5000"></textarea>
                        <div class="form-text">Maximum 5000 characters</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Privacy:</label>
                        <select class="form-select" id="uploadPrivacy">
                            <option value="public">Public</option>
                            <option value="unlisted">Unlisted</option>
                            <option value="private" selected>Private</option>
                        </select>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div class="progress-container" id="uploadProgressContainer">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-medium">Upload Progress</span>
                            <span id="uploadProgressText">0%</span>
                        </div>
                        <div class="upload-progress">
                            <div class="upload-progress-bar" id="uploadProgressBar"></div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted" id="uploadStatusText">Preparing upload...</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmUploadBtn" onclick="confirmUpload()">
                        <i class="fas fa-upload me-1"></i>
                        Start Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalTitle">
                        <i class="fas fa-play me-2"></i>
                        Video Preview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <video id="previewVideo" class="w-100" style="max-height: 70vh;" controls>
                        <source id="previewVideoSource" src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="mt-3" id="previewVideoInfo">
                        <!-- Video info will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="previewDownloadBtn" onclick="downloadVideoFromPreview()">
                        <i class="fas fa-download me-1"></i>
                        Download Video
                    </button>
                </div>
            </div>
        </div>
    </div>

    
    <script>
        let currentVideoId = null;
        let uploadModal = null;
        let previewModal = null;
        let currentPreviewVideoId = null;
        let videos = [];
        let channels = [];

        document.addEventListener('DOMContentLoaded', function() {
            uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
            previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
            loadVideoGallery();
            loadChannels();
        });

        async function loadVideoGallery() {
            showLoading(true);
            
            try {
                const response = await fetch('/api/video-gallery');
                const data = await response.json();
                
                if (data.success) {
                    videos = data.videos;
                    updateStatistics(data.stats);
                    displayVideos(videos);
                } else {
                    showError('Failed to load videos: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Error loading videos: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function loadChannels() {
            try {
                const response = await fetch('/api/youtube/channels');
                const data = await response.json();
                
                if (data.success) {
                    channels = data.channels;
                    updateChannelSelect();
                }
            } catch (error) {
                console.error('Error loading channels:', error);
            }
        }

        function updateChannelSelect() {
            const select = document.getElementById('uploadChannelSelect');
            select.innerHTML = '';
            
            if (channels.length === 0) {
                select.innerHTML = '<option value="">No channels configured</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Select a channel...</option>';
            
            channels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.id;
                option.textContent = channel.channel_name;
                
                // Add status indicator
                if (channel.oauth_authorized) {
                    option.textContent += ' âœ“';
                } else {
                    option.textContent += ' (Setup Required)';
                    option.disabled = true;
                }
                
                select.appendChild(option);
            });
        }

        function updateStatistics(stats) {
            document.getElementById('total-videos').textContent = stats.total_videos || 0;
            document.getElementById('ready-videos').textContent = stats.ready_to_upload || 0;
            document.getElementById('uploaded-videos').textContent = stats.uploaded_videos || 0;
            document.getElementById('total-size').textContent = (stats.total_size_mb || 0) + ' MB';
        }

        function displayVideos(videoList) {
            const gallery = document.getElementById('video-gallery');
            const noVideos = document.getElementById('no-videos');
            
            if (videoList.length === 0) {
                gallery.innerHTML = '';
                noVideos.style.display = 'block';
                return;
            }
            
            noVideos.style.display = 'none';
            
            const html = videoList.map(video => createVideoCard(video)).join('');
            gallery.innerHTML = html;
        }

        function createVideoCard(video) {
            const statusClass = getStatusClass(video.upload_status);
            const statusText = getStatusText(video.upload_status);
            
            return `
                <div class="video-card">
                    <div class="video-info">
                        <div class="video-header">
                            <div class="video-thumbnail">
                                <i class="fas fa-play"></i>
                            </div>
                            <div class="video-content">
                                <div class="video-title">${escapeHtml(video.title || video.video_title || 'Untitled Video')}</div>
                                
                                <div class="video-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-music"></i>
                                        <span>${escapeHtml(video.genre || 'Unknown')}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-microphone${video.vocal_type === 'instrumental' ? '-slash' : ''}"></i>
                                        <span>${video.vocal_type || 'Unknown'}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-clock"></i>
                                        <span>${formatDuration(video.duration)}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-hdd"></i>
                                        <span>${video.file_size_mb || 0} MB</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-calendar"></i>
                                        <span>${formatDate(video.created_at)}</span>
                                    </div>
                                </div>
                                
                                <div class="d-flex align-items-center gap-2">
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                    ${video.youtube_video_id ? `
                                        <a href="https://www.youtube.com/watch?v=${video.youtube_video_id}" 
                                           target="_blank" class="text-primary text-decoration-none">
                                            <i class="fab fa-youtube"></i> View on YouTube
                                        </a>
                                    ` : ''}
                                    ${!video.file_exists ? '<small class="text-danger"><i class="fas fa-exclamation-triangle"></i> File missing</small>' : ''}
                                </div>
                                
                                ${video.description ? `
                                    <div class="mt-2">
                                        <small class="text-muted">${escapeHtml(video.description.substring(0, 150))}${video.description.length > 150 ? '...' : ''}</small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="video-actions">
                        ${video.upload_status === 'ready' && video.file_exists ? `
                            <button class="btn btn-custom btn-upload" onclick="showUploadModal(${video.id})">
                                <i class="fas fa-upload"></i> Upload to YouTube
                            </button>
                        ` : ''}
                        
                        ${video.file_exists ? `
                            <button class="btn btn-custom btn-preview" onclick="previewVideo(${video.id})">
                                <i class="fas fa-play"></i> Preview
                            </button>
                            <button class="btn btn-custom btn-download" onclick="downloadVideo(${video.id})">
                                <i class="fas fa-download"></i> Download
                            </button>
                        ` : ''}
                        
                        <button class="btn btn-custom btn-delete" onclick="deleteVideo(${video.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        
                        ${video.upload_status === 'uploading' ? `
                            <div class="progress-container" style="display: block;">
                                <div class="upload-progress">
                                    <div class="upload-progress-bar" style="width: 50%;"></div>
                                </div>
                                <small class="text-muted">Uploading to YouTube...</small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'ready': return 'status-ready';
                case 'uploaded': return 'status-uploaded';
                case 'uploading': return 'status-uploading';
                case 'failed': return 'status-failed';
                default: return 'status-ready';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'ready': return 'Ready';
                case 'uploaded': return 'Uploaded';
                case 'uploading': return 'Uploading';
                case 'failed': return 'Failed';
                default: return 'Ready';
            }
        }

        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            // You can implement a toast notification system here
            alert(message);
        }

        function refreshGallery() {
            loadVideoGallery();
        }

        function filterVideos() {
            const statusFilter = document.getElementById('statusFilter').value;
            const genreFilter = document.getElementById('genreFilter').value;
            const vocalFilter = document.getElementById('vocalFilter').value;
            
            let filtered = videos;
            
            if (statusFilter) {
                filtered = filtered.filter(v => v.upload_status === statusFilter);
            }
            
            if (genreFilter) {
                filtered = filtered.filter(v => v.genre === genreFilter);
            }
            
            if (vocalFilter) {
                filtered = filtered.filter(v => v.vocal_type === vocalFilter);
            }
            
            displayVideos(filtered);
        }

        function showUploadModal(videoId) {
            currentVideoId = videoId;
            const video = videos.find(v => v.id === videoId);
            
            if (video) {
                document.getElementById('uploadVideoTitle').value = video.video_title || video.title || '';
                document.getElementById('uploadVideoDescription').value = video.video_description || video.description || '';
            }
            
            // Reset progress
            document.getElementById('uploadProgressContainer').style.display = 'none';
            document.getElementById('confirmUploadBtn').style.display = 'block';
            
            uploadModal.show();
        }

        async function confirmUpload() {
            const channelId = document.getElementById('uploadChannelSelect').value;
            const title = document.getElementById('uploadVideoTitle').value.trim();
            const description = document.getElementById('uploadVideoDescription').value.trim();
            const privacy = document.getElementById('uploadPrivacy').value;
            
            if (!channelId) {
                alert('Please select a channel');
                return;
            }
            
            if (!title) {
                alert('Please enter a video title');
                return;
            }
            
            // Find video info
            const video = videos.find(v => v.id === currentVideoId);
            if (!video) {
                alert('Video not found');
                return;
            }
            
            // Show progress
            document.getElementById('uploadProgressContainer').style.display = 'block';
            document.getElementById('confirmUploadBtn').style.display = 'none';
            
            try {
                const response = await fetch('/api/video/upload-youtube-gallery', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        video_id: currentVideoId,
                        channel_id: channelId,
                        title: title,
                        description: description,
                        privacy_status: privacy
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Start polling for progress
                    pollUploadProgress(data.task_id);
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
                
            } catch (error) {
                showError('Upload error: ' + error.message);
                document.getElementById('uploadProgressContainer').style.display = 'none';
                document.getElementById('confirmUploadBtn').style.display = 'block';
            }
        }

        async function pollUploadProgress(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}/status`);
                const data = await response.json();
                
                if (data.success) {
                    const task = data.task;
                    
                    // Update progress
                    const progressBar = document.getElementById('uploadProgressBar');
                    const progressText = document.getElementById('uploadProgressText');
                    const statusText = document.getElementById('uploadStatusText');
                    
                    const progress = Math.max(0, Math.min(100, task.progress || 0));
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';
                    statusText.textContent = task.current_step || 'Processing...';
                    
                    if (task.status === 'completed') {
                        // Success
                        progressText.textContent = '100%';
                        statusText.textContent = 'Upload completed successfully!';
                        
                        setTimeout(() => {
                            uploadModal.hide();
                            loadVideoGallery(); // Refresh gallery
                        }, 2000);
                        
                    } else if (task.status === 'failed') {
                        // Failed
                        statusText.textContent = 'Upload failed: ' + (task.result?.error || 'Unknown error');
                        statusText.className = 'text-danger';
                        
                        setTimeout(() => {
                            document.getElementById('uploadProgressContainer').style.display = 'none';
                            document.getElementById('confirmUploadBtn').style.display = 'block';
                        }, 3000);
                        
                    } else {
                        // Still running, poll again
                        setTimeout(() => pollUploadProgress(taskId), 2000);
                    }
                }
                
            } catch (error) {
                console.error('Error polling upload progress:', error);
                // Retry after delay
                setTimeout(() => pollUploadProgress(taskId), 5000);
            }
        }

        function previewVideo(videoId) {
            const video = videos.find(v => v.id === videoId);
            if (!video) {
                alert('Video not found');
                return;
            }
            
            currentPreviewVideoId = videoId;
            
            // Set up modal content
            document.getElementById('previewModalTitle').innerHTML = `
                <i class="fas fa-play me-2"></i>
                ${escapeHtml(video.title || 'Untitled Video')}
            `;
            
            // Set video source
            const previewUrl = `/api/video-gallery/${videoId}/preview`;
            document.getElementById('previewVideoSource').src = previewUrl;
            document.getElementById('previewVideo').load(); // Reload video element
            
            // Set video info
            document.getElementById('previewVideoInfo').innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <strong><i class="fas fa-music me-1"></i> Genre:</strong><br>
                        ${escapeHtml(video.genre || 'Unknown')}
                    </div>
                    <div class="col-md-3">
                        <strong><i class="fas fa-clock me-1"></i> Duration:</strong><br>
                        ${formatDuration(video.duration)}
                    </div>
                    <div class="col-md-3">
                        <strong><i class="fas fa-hdd me-1"></i> Size:</strong><br>
                        ${video.file_size_mb || 0} MB
                    </div>
                    <div class="col-md-3">
                        <strong><i class="fas fa-calendar me-1"></i> Created:</strong><br>
                        ${formatDate(video.created_at)}
                    </div>
                </div>
                ${video.description ? `
                    <div class="mt-3">
                        <strong><i class="fas fa-info-circle me-1"></i> Description:</strong><br>
                        <div class="text-muted">${escapeHtml(video.description)}</div>
                    </div>
                ` : ''}
            `;
            
            // Show modal
            previewModal.show();
        }

        function downloadVideoFromPreview() {
            if (currentPreviewVideoId) {
                downloadVideo(currentPreviewVideoId);
            }
        }

        function downloadVideo(videoId) {
            window.open(`/api/video-gallery/${videoId}/download`, '_blank');
        }

        async function deleteVideo(videoId) {
            if (!confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/video-gallery/${videoId}/delete`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadVideoGallery(); // Refresh gallery
                } else {
                    showError('Failed to delete video: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Error deleting video: ' + error.message);
            }
        }
    </script>
{% endblock %}