{% extends "admin_base.html" %}

{% block title %}Voice Cloning Empire - AI Character System{% endblock %}

{% block head %}
{{ super() }}
<style>
.voice-character-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 20px;
    margin: 15px 0;
    color: white;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.18);
}

.voice-character-card h5 {
    color: #fff;
    font-weight: bold;
    margin-bottom: 10px;
}

.character-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin: 15px 0;
}

.stat-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 10px;
    border-radius: 8px;
    text-align: center;
}

.stat-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #00ff88;
}

.stat-label {
    font-size: 0.8em;
    color: #ccc;
}

.revenue-multiplier {
    background: linear-gradient(45deg, #ff6b6b, #feca57);
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9em;
}

.performance-tier {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}

.tier-s { background: #ff6b6b; color: white; }
.tier-a { background: #feca57; color: white; }
.tier-b { background: #48dbfb; color: white; }
.tier-c { background: #ff9ff3; color: white; }
.tier-d { background: #95a5a6; color: white; }

.voice-content-preview {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 10px;
    margin: 10px 0;
    border-left: 4px solid #00ff88;
}

.script-text {
    font-style: italic;
    color: #e0e0e0;
    margin: 10px 0;
    padding: 10px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 5px;
}

.voice-controls {
    margin: 15px 0;
}

.voice-btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: bold;
    transition: all 0.3s ease;
    margin: 5px;
}

.voice-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.roi-indicator {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
    display: inline-block;
    margin: 5px 0;
}

.empire-stats {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    padding: 20px;
    border-radius: 15px;
    margin: 20px 0;
    color: white;
}

.empire-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.empire-stat-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
}

.empire-stat-value {
    font-size: 2em;
    font-weight: bold;
    color: #00ff88;
    margin: 10px 0;
}

.generation-progress {
    margin: 20px 0;
}

.progress-enhanced {
    height: 25px;
    background: #f8f9fa;
    border-radius: 15px;
    overflow: hidden;
}

.progress-bar-enhanced {
    background: linear-gradient(45deg, #667eea, #764ba2);
    height: 100%;
    border-radius: 15px;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-microphone-alt"></i> Voice Cloning Empire - AI Character System</h2>
            <p class="text-muted">Ultimate revenue boost: +$4,500/month with AI voice personalities</p>
        </div>
    </div>

    <!-- Empire Overview Stats -->
    <div class="empire-stats">
        <div class="row">
            <div class="col-12">
                <h4><i class="fas fa-crown"></i> Voice Empire Overview</h4>
            </div>
        </div>
        <div class="empire-stats-grid">
            <div class="empire-stat-card">
                <div class="empire-stat-value" id="totalCharacters">0</div>
                <div>Active Characters</div>
            </div>
            <div class="empire-stat-card">
                <div class="empire-stat-value" id="monthlyRevenue">$0</div>
                <div>Monthly Revenue</div>
            </div>
            <div class="empire-stat-card">
                <div class="empire-stat-value" id="totalContent">0</div>
                <div>Content Pieces</div>
            </div>
            <div class="empire-stat-card">
                <div class="empire-stat-value" id="roiPercentage">0%</div>
                <div>ROI Percentage</div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-control-alt"></i> Voice Empire Control Panel</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn voice-btn" onclick="initializeVoiceEmpire()">
                                <i class="fas fa-rocket"></i> Initialize Voice Empire
                            </button>
                            <button class="btn voice-btn" onclick="generateVoiceContent()">
                                <i class="fas fa-magic"></i> Generate Voice Content
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn voice-btn" onclick="refreshEmpireReport()">
                                <i class="fas fa-chart-line"></i> Refresh Empire Report
                            </button>
                            <button class="btn voice-btn" onclick="exportVoiceData()">
                                <i class="fas fa-download"></i> Export Voice Data
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content Generation Controls -->
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label>Content Count:</label>
                            <input type="number" id="contentCount" class="form-control" value="10" min="1" max="100">
                        </div>
                        <div class="col-md-4">
                            <label>Content Type:</label>
                            <select id="contentType" class="form-control">
                                <option value="mixed">Mixed Content</option>
                                <option value="meditation_intro">Meditation Intros</option>
                                <option value="track_description">Track Descriptions</option>
                                <option value="hype_intro">Hype Intros</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Target Style:</label>
                            <select id="targetStyle" class="form-control">
                                <option value="all">All Styles</option>
                                <option value="lofi_hiphop">Lo-Fi Hip Hop</option>
                                <option value="trap_beats">Trap Beats</option>
                                <option value="meditation_ambient">Meditation Ambient</option>
                                <option value="gaming_electronic">Gaming Electronic</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generation Progress -->
    <div class="generation-progress" id="generationProgress" style="display: none;">
        <h5>Voice Content Generation in Progress...</h5>
        <div class="progress-enhanced">
            <div class="progress-bar-enhanced" id="progressBar" style="width: 0%;">0%</div>
        </div>
        <div id="progressStatus" class="mt-2"></div>
    </div>

    <!-- Voice Characters Grid -->
    <div class="row" id="voiceCharactersGrid">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-users"></i> Voice Characters</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Click "Initialize Voice Empire" to create AI voice characters</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Voice Content -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-microphone"></i> Recent Voice Content</h5>
                </div>
                <div class="card-body" id="recentVoiceContent">
                    <p class="text-muted">No voice content generated yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Analytics -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Character Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="characterPerformanceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-dollar-sign"></i> Revenue Breakdown</h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueBreakdownChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Voice Character Modal -->
<div class="modal fade" id="characterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="characterModalTitle">Character Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="characterModalBody">
                <!-- Character details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn voice-btn" onclick="generateCharacterContent()">Generate Content</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let voiceEmpireData = {};
let currentCharacter = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    refreshEmpireReport();
});

// Initialize voice empire
async function initializeVoiceEmpire() {
    try {
        showLoader('Initializing AI voice characters...');
        
        const response = await fetch('/api/voice/initialize', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(`Voice empire initialized! Created ${result.data.total_created} characters. Projected revenue: $${result.data.estimated_monthly_revenue.toLocaleString()}/month`);
            refreshEmpireReport();
        } else {
            showError('Failed to initialize voice empire: ' + result.error);
        }
    } catch (error) {
        showError('Error initializing voice empire: ' + error.message);
    } finally {
        hideLoader();
    }
}

// Generate voice content
async function generateVoiceContent() {
    try {
        const count = document.getElementById('contentCount').value;
        
        // Show progress
        document.getElementById('generationProgress').style.display = 'block';
        updateProgress(0, 'Starting voice content generation...');
        
        const response = await fetch('/api/voice/generate-content', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ count: parseInt(count) })
        });
        
        const result = await response.json();
        
        if (result.success) {
            updateProgress(100, `Generated ${result.data.successful_generations} voice content pieces!`);
            
            setTimeout(() => {
                document.getElementById('generationProgress').style.display = 'none';
                showSuccess(`Voice content generated! Total revenue projection: $${result.data.total_projected_revenue.toFixed(0)}`);
                displayRecentVoiceContent(result.data.content_pieces);
                refreshEmpireReport();
            }, 2000);
        } else {
            updateProgress(0, 'Generation failed');
            showError('Failed to generate voice content: ' + result.error);
        }
    } catch (error) {
        updateProgress(0, 'Error occurred');
        showError('Error generating voice content: ' + error.message);
    }
}

// Update progress bar
function updateProgress(percentage, status) {
    const progressBar = document.getElementById('progressBar');
    const progressStatus = document.getElementById('progressStatus');
    
    progressBar.style.width = percentage + '%';
    progressBar.textContent = percentage + '%';
    progressStatus.textContent = status;
}

// Refresh empire report
async function refreshEmpireReport() {
    try {
        const response = await fetch('/api/voice/empire-report');
        const result = await response.json();
        
        if (result.success) {
            voiceEmpireData = result.report;
            updateEmpireStats(result.report);
            displayVoiceCharacters(result.report);
        } else {
            showError('Failed to load empire report: ' + result.error);
        }
    } catch (error) {
        showError('Error loading empire report: ' + error.message);
    }
}

// Update empire statistics
function updateEmpireStats(report) {
    document.getElementById('totalCharacters').textContent = report.total_characters;
    document.getElementById('monthlyRevenue').textContent = '$' + report.total_monthly_revenue.toLocaleString();
    document.getElementById('totalContent').textContent = report.total_content_pieces;
    document.getElementById('roiPercentage').textContent = report.roi_summary.roi_percentage.toFixed(1) + '%';
}

// Display voice characters
function displayVoiceCharacters(report) {
    const grid = document.getElementById('voiceCharactersGrid');
    
    if (report.total_characters === 0) {
        grid.innerHTML = `
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h5>No voice characters created yet</h5>
                        <p>Click "Initialize Voice Empire" to create AI voice characters</p>
                        <button class="btn voice-btn" onclick="initializeVoiceEmpire()">
                            <i class="fas fa-rocket"></i> Initialize Now
                        </button>
                    </div>
                </div>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    // Group characters by style
    for (const [style, characters] of Object.entries(report.characters_by_style)) {
        html += `
            <div class="col-12 mb-4">
                <h4><i class="fas fa-music"></i> ${style.replace('_', ' ').toUpperCase()} Characters</h4>
            </div>
        `;
        
        characters.forEach(char => {
            const performance = report.character_performances.find(p => p.character === char.name) || {};
            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="voice-character-card" onclick="showCharacterDetails('${char.name}')">
                        <h5><i class="fas fa-user-circle"></i> ${char.name}</h5>
                        
                        <div class="character-stats">
                            <div class="stat-item">
                                <div class="stat-value">$${(char.monthly_revenue || 0).toLocaleString()}</div>
                                <div class="stat-label">Monthly Revenue</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${(performance.content_count || 0)}</div>
                                <div class="stat-label">Content Pieces</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${((performance.avg_engagement || 0) * 100).toFixed(1)}%</div>
                                <div class="stat-label">Engagement</div>
                            </div>
                        </div>
                        
                        <div class="roi-indicator">
                            Revenue Multiplier: ${performance.revenue_multiplier || 3.2}x
                        </div>
                        
                        <div class="mt-2">
                            <span class="performance-tier tier-${(performance.performance_tier || 'Unknown').toLowerCase().charAt(0)}">
                                ${performance.performance_tier || 'New Character'}
                            </span>
                        </div>
                        
                        <div class="voice-controls mt-3">
                            <button class="btn btn-sm voice-btn" onclick="event.stopPropagation(); generateCharacterScript('${char.name}')">
                                <i class="fas fa-file-alt"></i> Generate Script
                            </button>
                            <button class="btn btn-sm voice-btn" onclick="event.stopPropagation(); viewCharacterPerformance('${char.name}')">
                                <i class="fas fa-chart-line"></i> Performance
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    grid.innerHTML = html;
}

// Display recent voice content
function displayRecentVoiceContent(contentPieces) {
    const container = document.getElementById('recentVoiceContent');
    
    if (!contentPieces || contentPieces.length === 0) {
        container.innerHTML = '<p class="text-muted">No voice content generated yet</p>';
        return;
    }
    
    let html = '';
    contentPieces.slice(0, 5).forEach(content => {
        html += `
            <div class="voice-content-preview">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6><i class="fas fa-microphone"></i> ${content.character} - ${content.channel_style}</h6>
                        <div class="script-text">"${content.script}"</div>
                        <small class="text-muted">Type: ${content.content_type} | Duration: ${content.duration.toFixed(1)}s</small>
                    </div>
                    <div class="text-end">
                        <div class="revenue-multiplier">${content.revenue_multiplier}x RPM</div>
                        <div class="roi-indicator">$${content.projected_revenue.toFixed(0)}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Show character details modal
function showCharacterDetails(characterName) {
    currentCharacter = characterName;
    
    const modal = new bootstrap.Modal(document.getElementById('characterModal'));
    document.getElementById('characterModalTitle').textContent = `${characterName} - Character Details`;
    
    // Load character performance
    loadCharacterPerformance(characterName);
    
    modal.show();
}

// Load character performance
async function loadCharacterPerformance(characterName) {
    try {
        const response = await fetch(`/api/voice/character-performance/${characterName}?days=30`);
        const result = await response.json();
        
        if (result.success) {
            displayCharacterDetails(result.performance);
        } else {
            document.getElementById('characterModalBody').innerHTML = 
                '<p class="text-danger">Failed to load character performance</p>';
        }
    } catch (error) {
        document.getElementById('characterModalBody').innerHTML = 
            '<p class="text-danger">Error loading character performance</p>';
    }
}

// Display character details
function displayCharacterDetails(performance) {
    const modalBody = document.getElementById('characterModalBody');
    
    modalBody.innerHTML = `
        <div class="character-stats">
            <div class="stat-item">
                <div class="stat-value">${performance.content_count}</div>
                <div class="stat-label">Content Pieces (30 days)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">${(performance.avg_views || 0).toLocaleString()}</div>
                <div class="stat-label">Average Views</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">$${(performance.total_revenue || 0).toFixed(0)}</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">$${(performance.projected_monthly || 0).toFixed(0)}</div>
                <div class="stat-label">Projected Monthly</div>
            </div>
        </div>
        
        <div class="mt-3">
            <h6>Performance Metrics</h6>
            <div class="progress mb-2">
                <div class="progress-bar bg-success" style="width: ${(performance.optimization_score || 0) * 100}%">
                    Optimization Score: ${((performance.optimization_score || 0) * 100).toFixed(1)}%
                </div>
            </div>
            
            <div class="alert alert-info">
                <strong>Performance Tier:</strong> ${performance.performance_tier || 'Unknown'}<br>
                <strong>Revenue Multiplier:</strong> ${performance.revenue_multiplier || 3.2}x
            </div>
        </div>
    `;
}

// Generate character content
async function generateCharacterContent() {
    if (!currentCharacter) return;
    
    try {
        showLoader('Generating content for ' + currentCharacter + '...');
        
        const response = await fetch('/api/voice/generate-script', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                character_name: currentCharacter,
                content_type: 'track_description',
                music_context: {
                    mood: 'energetic',
                    genre: 'electronic',
                    purpose: 'motivation'
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Script generated successfully!');
            // You could add voice synthesis here
        } else {
            showError('Failed to generate script: ' + result.error);
        }
    } catch (error) {
        showError('Error generating script: ' + error.message);
    } finally {
        hideLoader();
    }
}

// Utility functions
function showSuccess(message) {
    showAlert('success', message);
}

function showError(message) {
    showAlert('danger', message);
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

function showLoader(message) {
    // Implementation depends on your existing loader system
    console.log('Loading:', message);
}

function hideLoader() {
    // Implementation depends on your existing loader system
    console.log('Loading complete');
}

// Export voice data
function exportVoiceData() {
    const dataStr = JSON.stringify(voiceEmpireData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = 'voice_empire_data.json';
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}
</script>
{% endblock %}